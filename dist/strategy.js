"use strict";const t={};module.exports=t,t.decorateAgent=function(e,...r){e.customStrategy||(e.customStrategy=function(t){}),e.staticCustomStrategy||(e.staticCustomStrategy=function(t){}),e.getStrategyHandler=function(t,e,...r){const n=this.currentStrategy||this.strategy(t),a=n[e],s=n.key,i=n.name;if(DEBUG&&TRACE&&trace("Strategy",{agent:this.name,strategyKey:s,strategyName:i,method:e}),void 0===a)return void logError("strategy handler returned undefined",{agent:this.name||this.id,strategyKey:s,strategyName:i,method:e,stack:(new Error).stack});if(0===r.length)return a;const g=a.apply(this.currentStrategy,r);return void 0!==g?g:void logError("handler returned undefined for args",{agent:this.name||this.id,strategyKey:s,strategyName:i,method:e,args:r.toString(),stack:(new Error).stack})},e._strategyCache={},e.strategyKey=function(t){const e=[];for(let n=r.length-1;n>=0;n--)t[n]?e[n]=t[n]:e[n]=r[n].default(this);return e},e.selectClient=function(t,e){return t[e]&&r[e].select(t[e])},e.strategy=function(e){const n=this.strategyKey(e);let a=t.getCachedStrategy(this,n);return a?t.customizeStrategy(this,n,a):(a=t.buildStrategy(n,t.strategyChainUtils,r,this.staticCustomStrategy.apply(this,n)))?(t.putCachedStrategy(this,n,a),t.customizeStrategy(this,n,a)):(logError("no strategy",{agent:this.name||this.id,key:n}),{})},e.explain=function(){const t=this.strategyKey([]);let e=this.toString()+": ";this.explainAgent&&(e+=this.explainAgent()+" "),e+=`assigned:[${t}]`;for(let r=0;r<t.length;r++){const n=this.selectClient(r);n&&n.explain&&(e+=`
\t${t[r]}: ${n.explain(this)}`)}return e}},t.allocateStrategy=function(t,...e){t.currentStrategy=t.strategy.apply(t,e)},t.freeStrategy=function(e){t.freeStrategyChain(e.currentStrategy),delete e.currentStrategy},t.buildStrategy=function(e,r,n,a){const s={key:e,name:[]};t.appendStrategies(s,void 0,[r]);let i;for(let g=0;g<n.length;g++){const r=e[g],a=r&&n[g].selector(r),o=a&&a.selectStrategies&&a.selectStrategies.apply(a,e);i=t.appendStrategies(s,i,o)}if(a&&(i=t.appendStrategies(s,i,[a])),i)return s},t.appendStrategies=function(t,e,r){if(!r)return e;for(let n=0;n<r.length;n++){const a=r[n];a&&(e=a,_.assign(t,a,function(t,e,r){return"name"===r?(t.push(e),t):e}))}return e},t.freeStrategyChain=function(t){},t.customizeStrategy=function(t,e,r){const n=t.customStrategy.apply(t,e);return n?_.assign({},r,n,function(t,e,r){return"name"===r?Array.isArray(e)?e.slice(0):(t.push(e),t):e}):r},t.strategyChainUtils={toString:function(){const e=this.name.toString();return t.freeStrategy(this),e},[Symbol.toPrimitive]:function(){return this.toString()}},t.getCachedStrategy=function(t,e){return _.get(t._strategyCache,e)},t.putCachedStrategy=function(t,e,r){Object.freeze(r),_.set(t._strategyCache,e,r)};
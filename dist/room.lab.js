const e={};module.exports=e,e.analyzeRoom=function(e,r){r&&e.saveLabs(),e.structures.labs.all.length>0&&e.processLabs()},e.extend=function(){Room.Labs=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let e=e=>{let r=Game.getObjectById(e.id);r&&(_.assign(r,e),this._all.push(r))};_.forEach(this.room.memory.labs,e)}return this._all}},storage:{configurable:!0,get:function(){if(_.isUndefined(this._storage)){let e=e=>e.storage===!0;this._storage=this.all.filter(e)}return this._storage}}})},Room.prototype.saveLabs=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType==STRUCTURE_LAB});if(e.length>0){this.memory.labs=[];let r=this.storage?this.storage.pos.findInRange(e,2).map(e=>e.id):[];this.memory.labs=[];let t=e=>{let t=this.memory.labs.find(r=>r.id==e.id);t||this.memory.labs.push({id:e.id,storage:r.includes(e.id)})};e.forEach(t)}else delete this.memory.labs},Room.prototype.processLabs=function(){if(Game.time%LAB_COOLDOWN===5){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}});if(this.memory.resources){let r=e.filter(e=>{let r=this.memory.resources.lab.find(r=>r.id==e.id);return!!r&&(r.slave_a&&r.slave_b)});for(let t=0;t<r.length;t++){let e=r[t];if(!(e.cooldown>0)){let r=this.memory.resources.lab.find(r=>r.id==e.id);if(r){let t=r.reactionType;if(!(e.mineralAmount>0&&e.mineralType!=t)){let o=Game.getObjectById(r.slave_a),i=Game.getObjectById(r.slave_b);o&&o.mineralType==LAB_REACTIONS[t][0]&&i&&i.mineralType==LAB_REACTIONS[t][1]&&e.runReaction(o,i)==OK&&(r.reactionAmount-=LAB_REACTION_AMOUNT,global.DEBUG&&global.TRACE&&trace("Room",{roomName:this.name,actionName:"processLabs",labId:e.id,resourceType:t,amountRemaining:r.reactionAmount}),r.reactionAmount<=0&&this.cancelReactionOrder(e.id))}}}}let o=this.memory.resources.reactions;if(o)switch(o.reactorType){case REACTOR_TYPE_FLOWER:this.processReactorFlower()}}}},Room.prototype.processReactorFlower=function(){let e=this.memory.resources.reactions;if(e&&e.reactorType===REACTOR_TYPE_FLOWER){for(let r=0;r<e.orders.length&&e.orders[r].amount<LAB_REACTION_AMOUNT;r++)e.orders.splice(r--,1);if(0===e.orders.length){let r=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}});for(let t=0;t<r.length;t++){let e=r[t],o=this.memory.resources.lab.find(r=>r.id===e.id);!o||o.reactionState!==LAB_IDLE&&o.reactionState!==LAB_SEED||this.cancelReactionOrder(e.id)}return void(e.reactorMode=REACTOR_MODE_IDLE)}let t=e.orders[0];switch(e.reactorMode=t.mode,e.reactorMode){case REACTOR_MODE_BURST:this.processReactorFlowerBurst()}}},Room.prototype.processReactorFlowerBurst=function(){let e=this.memory.resources.reactions;if(e&&e.reactorType===REACTOR_TYPE_FLOWER&&e.reactorMode===REACTOR_MODE_BURST){let r=e.orders[0];if(r.mode===REACTOR_MODE_BURST){let t=LAB_REACTIONS[r.type][0],o=LAB_REACTIONS[r.type][1],i=Game.getObjectById(e.seed_a),n=Game.getObjectById(e.seed_b);if(i&&n){let a=this.memory.resources.lab.find(r=>r.id===e.seed_a),s=this.memory.resources.lab.find(r=>r.id===e.seed_b);if(a&&a.reactionType===t||(this.placeOrder(e.seed_a,t,r.amount),a=this.memory.resources.lab.find(r=>r.id===e.seed_a),a.reactionType=t),s&&s.reactionType===o||(this.placeOrder(e.seed_b,o,r.amount),s=this.memory.resources.lab.find(r=>r.id===e.seed_b),s.reactionType=o),a&&s){let c=a.orders.find(e=>e.type===t),m=s.orders.find(e=>e.type===o);(!c||c.amount<r.amount)&&this.placeOrder(e.seed_a,t,r.amount-(c?c.orderAmount:0)),(!m||m.amount<r.amount)&&this.placeOrder(e.seed_b,o,r.amount-(m?m.orderAmount:0));let d=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}}),u=d.filter(e=>{let r=this.memory.resources.lab.find(r=>r.id===e.id);return!r||r.reactionState===LAB_IDLE});for(let l=0;l<u.length;l++){let e=u[l],t=this.memory.resources.lab.find(r=>r.id===e.id);t||(this.prepareReactionOrder(e.id,r.type,r.amount),t=this.memory.resources.lab.find(r=>r.id===e.id)),t&&(t.reactionType=r.type)}if(i.mineralType===t&&n.mineralType===o){let e=Math.floor(Math.min(i.mineralAmount,n.mineralAmount,r.amount)/LAB_REACTION_AMOUNT);if(0!==e){let t=0;for(let o=0;o<u.length;o++){let a=u[o];(0===a.mineralAmount||a.mineralType===r.type&&a.mineralAmount<=a.mineralCapacity-LAB_REACTION_AMOUNT&&t<e)&&(t++,a.runReaction(i,n)===OK&&(r.amount-=LAB_REACTION_AMOUNT,global.DEBUG&&global.TRACE&&trace("Room",{roomName:this.name,actionName:"processLabs",reactorType:REACTOR_TYPE_FLOWER,labId:a.id,resourceType:r.type,amountRemaining:r.amount})))}}}}}}}},Room.prototype.cancelReactionOrder=function(e,r){let t=this.memory.resources.lab.find(r=>r.id==e);if(!r||_.matches(r)(e)){if(t){t.slave_a&&this.cancelReactionOrder(t.slave_a,{master:e}),t.slave_b&&this.cancelReactionOrder(t.slave_b,{master:e});let r=[LAB_MASTER,LAB_SLAVE_1,LAB_SLAVE_2,LAB_SLAVE_3];r.includes(t.reactionState)&&(t.reactionState=LAB_IDLE),delete t.reactionType,delete t.reactionAmount,delete t.master,delete t.slave_a,delete t.slave_b,void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.orders&&(this.memory.resources.orders=[]);this.memory.resources.orders;for(let o=0;o<t.orders.length;o++){let e=t.orders[o];e.type!=RESOURCE_ENERGY&&(e.orderAmount=0,e.orderRemaining=0,e.storeAmount=0)}}return OK}},Room.prototype.prepareReactionOrder=function(e,r,t){if(t<=0)return OK;let o=Game.getObjectById(e);if(!this.my||!o||!o.structureType==STRUCTURE_LAB)return ERR_INVALID_TARGET;if(!LAB_REACTIONS.hasOwnProperty(r))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]});let i=this.memory.resources.lab.find(r=>r.id==e);return i||(this.memory.resources.lab.push({id:e,orders:[],reactionState:LAB_IDLE}),i=this.memory.resources.lab.find(r=>r.id==e)),this.cancelReactionOrder(e),OK},Room.prototype.placeBasicReactionOrder=function(e,r,t,o=1){if(t<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(r))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=Game.getObjectById(e),n=LAB_REACTIONS[r][0],a=LAB_REACTIONS[r][1],s=null,c=null,m=i.pos.findInRange(FIND_MY_STRUCTURES,2,{filter:e=>{return e.structureType==STRUCTURE_LAB&&e.id!=i.id}});for(let d=0;d<m.length;d++){let e=m[d],r=this.memory.resources.lab.find(r=>r.id==e.id);if(null==s&&r&&r.reactionType==n?s=e:null==c&&r&&r.reactionType==a&&(c=e),s&&c)break}if(!s||!c){m.sort((e,r)=>i.pos.getRangeTo(e)-i.pos.getRangeTo(r));for(let e=0;e<m.length;e++){let r=m[e],t=this.memory.resources.lab.find(e=>e.id==r.id);t&&t.reactionState&&t.reactionState!=LAB_IDLE||(null==s?s=r:null==c&&(c=r))}}if(null==s||null==c)return ERR_NOT_FOUND;let u=this.prepareReactionOrder(e,r,t);if(u!=OK)return u;if(u=this.prepareReactionOrder(s.id,r,t),u!=OK)return u;if(u=this.prepareReactionOrder(c.id,r,t),u!=OK)return u;let l=this.memory.resources.lab.find(r=>r.id==e),R=LAB_MASTER;l&&(l.reactionState==LAB_SLAVE_1&&(R=LAB_SLAVE_1),l.reactionState==LAB_SLAVE_2&&(R=LAB_SLAVE_2),l.reactionState=R,l.reactionType=r,l.reactionAmount=t,l.slave_a=s.id,l.slave_b=c.id),l=this.memory.resources.lab.find(e=>e.id==s.id);let _=LAB_SLAVE_1,f=1;if(R==LAB_SLAVE_1?(_=LAB_SLAVE_2,f=2):R==LAB_SLAVE_2&&(_=LAB_SLAVE_3,f=3),l){l.reactionState=_,l.reactionType=n,l.master=i.id,this.placeOrder(s.id,n,t);let e=0;if(this.memory.container)for(let r=0;r<this.memory.container.length;r++){let t=this.memory.container[r],o=Game.getObjectById(t.id);o&&o.store[n]&&(e+=o.store[n])}if(this.storage&&(e+=this.storage.store[n]||0),this.terminal&&(e+=this.terminal.store[n]||0),o>f&&f<3&&e<t&&this.placeReactionOrder(s.id,n,t-e)==OK){let r=l.orders.find(e=>e.type==n);r&&(r.orderRemaining=e)}}if(l=this.memory.resources.lab.find(e=>e.id==c.id)){l.reactionState=_,l.reactionType=a,l.master=i.id,this.placeOrder(c.id,a,t);let e=0;if(this.memory.container)for(let r=0;r<this.memory.container.length;r++){let t=this.memory.container[r],o=Game.getObjectById(t.id);o&&(e+=o.store[a]||0)}if(this.storage&&(e+=this.storage.store[a]||0),this.terminal&&(e+=this.terminal.store[a]||0),o>f&&f<3&&e<t&&this.placeReactionOrder(s.id,n,t-e)==OK){let r=l.orders.find(e=>e.type==a);r&&(r.orderRemaining=e)}}return OK},Room.prototype.placeFlowerReactionOrder=function(e,r,t,o=REACTOR_MODE_BURST){if(t<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(r))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=this.memory.resources;if(i.reactions){let n=i.reactions.orders.find(t=>{return t.id==e&&t.type==r});n?(global.DEBUG&&global.TRACE&&trace("Room",{roomName:this.name,actionName:"placeReactionOrder",subAction:"update",orderId:e,resourceType:r,amount:t}),n.mode=o,n.amount=t):(global.DEBUG&&global.TRACE&&trace("Room",{roomName:this.name,actionName:"placeReactionOrder",subAction:"new",orderId:e,resourceType:r,amount:t}),i.reactions.orders.push({id:e,type:r,mode:o,amount:t})),i.reactions.reactorMode=o}return OK},Room.prototype.placeReactionOrder=function(e,r,t,o=REACTOR_MODE_BURST){if(t<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(r))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=Game.getObjectById(e);if(i&&i.structureType===STRUCTURE_LAB)return this.placeBasicReactionOrder(e,r,t,1);let n=this.memory.resources;if(!n.reactions)return global.DEBUG&&global.TRACE&&trace("Room",{roomName:this.name,actionName:"placeRoomOrder",subAction:"no_reactor"}),ERR_INVALID_TARGET;n.reactions.reactorType;switch(n.reactions.reactorType){case REACTOR_TYPE_FLOWER:this.placeFlowerReactionOrder(e,r,t,o)}return OK},Room.prototype.registerReactorFlower=function(e,r){void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let t=Game.getObjectById(e),o=Game.getObjectById(r);if(!t||!o||t.structureType!==STRUCTURE_LAB||o.structureType!==STRUCTURE_LAB)return ERR_INVALID_TARGET;let i=this.memory.resources;return void 0===i.reactions&&(i.reactions={orders:[]}),i.reactions.reactorType=REACTOR_TYPE_FLOWER,i.reactions.reactorMode=REACTOR_MODE_IDLE,i.reactions.seed_a=e,i.reactions.seed_b=r,data_a=i.lab.find(r=>r.id===e),data_a&&(data_a.reactionState=LAB_SEED),data_b=i.lab.find(e=>e.id===r),data_b&&(data_b.reactionState=LAB_SEED),OK}};
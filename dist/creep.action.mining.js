const e=new Creep.Action("mining");module.exports=e,e.renewTarget=!0,e.isValidTarget=function(e,t){return e&&(e instanceof Source||e instanceof Mineral&&!e.ticksToRegeneration)},e.isAddableAction=function(e){const t=e.room;return t.my||t.myReservation||!t.owner&&!t.reservation},e.isAddableTarget=function(e,t){const a=e=>{const a=e.predictedRenewal?e.predictedRenewal:e.spawningTime;return e.creepType===t.data.creepType&&e.ttl>a};return!e.targetOf||!_.some(e.targetOf,a)},e.newTarget=function(t){const a=t.getStrategyHandler([e.name],"newTarget",t);return a&&this.determineSpot(t,a),a},e.determineSpot=function(e,t){const a=[],n=t=>{if(t.name!==e.name){const n=t.predictedRenewal?t.predictedRenewal:t.spawningTime;t.roomName===e.pos.roomName&&["miner","upgrader"].includes(t.creepType)&&t.determinatedSpot&&t.ttl>n&&a.push(t.determinatedSpot)}};_.forEach(Memory.population,n);const r=t.container&&t.container.pos.isNearTo(t)&&!_.some(a,{x:t.container.pos.x,y:t.container.pos.y})?t.container.pos:null;let o,i=[];if(r||(o={spots:[{pos:t.pos,range:1}],checkWalkable:!0,where:e=>!_.some(a,{x:e.x,y:e.y}),roomName:e.pos.roomName},t.container&&o.spots.push({pos:t.container.pos,range:1}),!e.remote&&t.link&&o.spots.push({pos:t.link.pos,range:1}),i=Room.fieldsInRange(o)),r||i.length>0){let a=r;if(a||(a=e.pos.findClosestByPath(i,{filter:t=>{return!_.some(e.room.lookForAt(LOOK_STRUCTURES,t),{structureType:STRUCTURE_ROAD})}})),a||(a=e.pos.findClosestByPath(i)||i[0]),a){if(e.data.determinatedSpot={x:a.x,y:a.y},!e.remote){const t=Game.spawns[e.data.motherSpawn];if(t){const n=a.findPathTo(t,{ignoreCreeps:!0});n&&(e.data.predictedRenewal=e.data.spawningTime+n.length)}}if(MINERS_AUTO_BUILD&&!t.container){const e=_.filter(t.pos.findInRange(FIND_CONSTRUCTION_SITES,2),e=>e.structureType===STRUCTURE_CONTAINER);!e.length&&t.room&&t.room.createConstructionSite(a,STRUCTURE_CONTAINER)}}}e.data.determinatedSpot||logError("Unable to determine working location for miner in room "+e.pos.roomName)},e.work=function(e){if(0===e.target.energy||e.target.cooldown>0)this.maintain(e);else{if(!(e.target instanceof Mineral&&e.target.ticksToRegeneration>0)){this.resetChecks(e);const t=e.carryCapacity-(e.data.body&&e.data.body.work?2*e.data.body.work:e.carryCapacity/2);if(e.sum>t)if(e.target.link&&e.target.link.energy<e.target.link.energyCapacity)e.transfer(e.target.link,RESOURCE_ENERGY);else if(e.target.container&&e.target.container.sum<e.target.container.storeCapacity){const t=t=>{e.carry[t]>0&&e.transfer(e.target.container,t)};_.forEach(Object.keys(e.carry),t)}else{global.CHATTY&&e.say("dropmining",global.SAY_PUBLIC),global.OOPS&&e.say(String.fromCharCode(8681),global.SAY_PUBLIC);const t=t=>{e.carry[t]>0&&e.drop(t)};_.forEach(Object.keys(e.carry),t)}return e.harvest(e.target)}this.resetChecks(e),this.unassign(e)}},e.resetChecks=function(e){delete e.data.repairChecked,delete e.data.repairTarget,delete e.data.buildChecked,delete e.data.buildTarget,delete e.data.energyChecked},e.step=function(e){if(_.isUndefined(e.data.determinatedSpot))this.determineSpot(e,e.target);else{const t=e.data.destiny?e.data.destiny.room:e.data.homeRoom,a=new RoomPosition(e.data.determinatedSpot.x,e.data.determinatedSpot.y,t),n=e.pos.getRangeTo(a);if(n>1)e.travelTo(a,{range:1});else if(1===n){const t=a.lookFor(LOOK_CREEPS).length>0;t||e.move(e.pos.getDirectionTo(a))}else this.work(e)}},e.getEnergy=function(e){const t=e.pos.findInRange(FIND_DROPPED_ENERGY,1)[0];if(t)return global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"getEnergy",creepName:e.name,pos:e.pos,pickup:t.id}),e.pickup(t),!0;const a=e.pos.findInRange(FIND_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_CONTAINER})[0];if(a&&a.sum>0)return global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"getEnergy",creepName:e.name,pos:e.pos,withdrawCon:a.id}),e.withdraw(a,RESOURCE_ENERGY),!0;const n=e.pos.findInRange(FIND_STRUCTURES,1,{filter:e=>e.my&&e.structureType===STRUCTURE_LINK})[0];return n&&n.energy>0?(global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"getEnergy",creepName:e.name,pos:e.pos,withdrawLink:n.id}),e.withdraw(n,RESOURCE_ENERGY),!0):(global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"getEnergy",creepName:e.name,pos:e.pos,result:"no energy"}),e.data.energyChecked=Game.time,!1)},e.maintain=function(e){const t=e.data.body&&e.data.body.work?5*e.data.body.work:e.carryCapacity/2;if(global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"maintain",creepName:e.name,pos:e.pos,energy:e.carryenergy,minCarry:t}),e.carry.energy<=t&&(!e.data.energyChecked||Game.time-e.data.energyChecked>MINER_WORK_THRESHOLD)&&this.getEnergy(e),e.carry.energy>0){if(!e.data.repairChecked||Game.time-e.data.repairChecked>MINER_WORK_THRESHOLD){let t=Game.getObjectById(e.data.repairTarget);if(t&&t.hits!==t.hitsMax||(t=e.pos.findInRange(FIND_STRUCTURES,3,{filter:e=>(e.structureType===STRUCTURE_CONTAINER||e.structureType===STRUCTURE_ROAD)&&e.hits<e.hitsMax})[0]),t)return e.data.repairTarget=t.id,global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"maintain",creepName:e.name,pos:e.pos,repairTarget:t.id,progress:t.hits/t.hitsMax}),e.repair(t);delete e.data.repairTarget,e.data.repairChecked=Game.time}if(!e.data.buildChecked||Game.time-e.data.buildChecked>MINER_WORK_THRESHOLD){let t=Game.getObjectById(e.data.buildTarget);if(t&&t.progress!==t.progressMax||(t=e.pos.findInRange(e.room.myConstructionSites,3,{filter:e=>(e.structureType===STRUCTURE_CONTAINER||e.structureType===STRUCTURE_ROAD)&&e.progress<e.progressMax})[0]),t)return e.data.buildTarget=t.id,global.DEBUG&&global.TRACE&&trace("Action",{actionName:this.name,method:"maintain",creepName:e.name,pos:e.pos,buildTarget:t.id,progress:t.progress/t.progressMax}),e.build(t);delete e.data.buildTarget,e.data.buildChecked=Game.time}}return!1},e.defaultStrategy.newTarget=function(e){const t=t=>Creep.action.mining.isValidTarget(t,e)&&Creep.action.mining.isAddableTarget(t,e);return _(e.room.sources).sortBy(t=>e.pos.getRangeTo(t)).find(t)||null};
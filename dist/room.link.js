const t={};module.exports=t,t.analyzeRoom=function(t,i){i&&t.saveLinks(),t.structures.links.all.length>0&&t.linkDispatcher()},t.extend=function(){Room.Links=function(t){this.room=t,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let t=t=>{let i=Game.getObjectById(t.id);i&&(_.assign(i,t),this._all.push(i))};_.forEach(this.room.memory.links,t)}return this._all}},controller:{configurable:!0,get:function(){if(_.isUndefined(this._controller)){let t=t=>t.controller===!0;this._controller=this.all.filter(t)}return this._controller}},storage:{configurable:!0,get:function(){if(_.isUndefined(this._storage)){let t=t=>1==t.storage;this._storage=this.all.filter(t)}return this._storage}},in:{configurable:!0,get:function(){if(_.isUndefined(this._in)){let t=t=>0==t.storage&&0==t.controller;this._in=_.filter(this.all,t)}return this._in}},privateers:{configurable:!0,get:function(){if(_.isUndefined(this._privateers)){let t=t=>0==t.storage&&0==t.controller&&0==t.source&&t.energy<.85*t.energyCapacity;this._privateers=_.filter(this.all,t)}return this._privateers}}})},Room.prototype.saveLinks=function(){let t=this.find(FIND_MY_STRUCTURES,{filter:t=>t.structureType==STRUCTURE_LINK});if(t.length>0){this.memory.links=[];let i=this.storage?this.storage.pos.findInRange(t,2).map(t=>t.id):[];/*
            let kept = [];
            let keep = (entry) => {
                if( links.find( (c) => c.id == entry.id )){
                    entry.storage = storageLinks.includes(entry.id);
                    kept.push(entry);
                }
            };
            this.memory.links.forEach(keep);
            this.memory.links = kept;
            */
this.memory.links=[];let e=t=>{if(!this.memory.links.find(i=>i.id==t.id)){let e=t.pos.getRangeTo(this.controller)<=4,n=!1;if(!e){let i=t.pos.findInRange(this.sources,2),e=i=>i.memory.link=t.id;i.forEach(e),n=i.length>0}this.memory.links.push({id:t.id,storage:i.includes(t.id),controller:e,source:n})}};t.forEach(e)}else delete this.memory.links},Room.prototype.linkDispatcher=function(){let t=t=>0==t.cooldown&&t.energy>=t.energyCapacity*(t.source?.85:.5),i=t=>t.energy<.15*t.energyCapacity,e=this.structures.links.in.filter(t),n=this.structures.links.controller.filter(i);if(e.length>0){let t=this.structures.links.storage.filter(i),r=i=>{n.length>0?(i.transferEnergy(n[0]),n.shift()):t.length>0&&(i.transferEnergy(t[0]),t.shift())};e.forEach(r)}if(n.length>0){let i=this.structures.links.storage.filter(t),e=t=>{n.length>0&&(t.transferEnergy(n[0]),n.shift())};i.forEach(e)}}};
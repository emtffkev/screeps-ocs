let t=function(e){this.none={fixedBody:[],multiBody:[],minAbsEnergyAvailable:1/0,minEnergyAvailable:1,maxMulti:0,maxCount:0,maxWeight:0},this.RCL={1:this.none,2:this.none,3:this.none,4:this.none,5:this.none,6:this.none,7:this.none,8:this.none},this.type=e,this.minControllerLevel=0,this.globalMeasurement=!1,this.measureByHome=!1,this.sortedParts=!0,this.mixMoveParts=!1,this.rclProperty=t.rclProperty,this.SelfOrCall=function(t,e){return null==t?null:"function"==typeof t?t.apply(this,[e]):t},this._fixedBody=this.rclProperty("fixedBody"),this._multiBody=this.rclProperty("multiBody"),this._minAbsEnergyAvailable=this.rclProperty("minAbsEnergyAvailable"),this._minEnergyAvailable=this.rclProperty("minEnergyAvailable"),this._minMulti=this.rclProperty("minMulti"),this._maxMulti=this.rclProperty("maxMulti"),this._maxCount=this.rclProperty("maxCount"),this._maxWeight=this.rclProperty("maxWeight"),this.buildParams=function(t){var e={setup:null,name:null,parts:[],cost:0,mother:null,home:null,breeding:1};e.setup=this.type,e.parts=this.parts(t.room),e.cost=Creep.bodyCosts(e.parts),e.mother=t.name,e.home=t.pos.roomName;for(var i=1;null==e.name||Game.creeps[e.name]||Memory.population[e.name];i++)e.name=this.type+"-"+e.cost+"-"+i;return e},this.isValidSetup=function(e){if(e.controller.level<this.minControllerLevel)return global.DEBUG&&global.TRACE&&trace("Setup",{setupType:this.type,room:e.name,rcl:e.controller.level,Setup:"isValidSetup"},"low RCL"),!1;let i=this.SelfOrCall(this._minAbsEnergyAvailable,e),r=this.SelfOrCall(this._minEnergyAvailable,e);const n=e.remainingEnergyAvailable,l=e.relativeRemainingEnergyAvailable;if(n<i||l<r)return global.DEBUG&&global.TRACE&&trace("Setup",{setupType:this.type,room:e.name,absEnergy:n,energy:l,Setup:"isValidSetup"},"not enough energy"),!1;let o=this.SelfOrCall(this._maxCount,e),s=this.SelfOrCall(this._maxWeight,e);if(0===o||0===s)return global.DEBUG&&global.TRACE&&trace("Setup",{setupType:this.type,room:e.name,maxCount:o,maxWeight:s,Setup:"isValidSetup"},"too many creeps"),!1;null==o&&(o=1/0),null==s&&(s=1/0);let a=0,u=0;if(this.measureByHome){let i=e.name,r=e=>{e.creepType==this.type&&e.homeRoom==i&&t.isWorkingAge(e)&&(a++,u+=e.weight)};_.forEach(Memory.population,r)}else{let t=this.globalMeasurement?Population:e.population;if(!t||!t.typeCount[this.type])return!0;a=t.typeCount[this.type]||0,u=t.typeWeight[this.type]||0}const h=a<o&&u<s;return global.DEBUG&&global.TRACE&&trace("Setup",{setupType:this.type,room:e.name,returnVal:h,Setup:"isValidSetup"},"count:",a,"<",o,"weight:",u,"<",s),h},this.existingWeight=function(t){let e=0;if(this.measureByHome){let i=t.name,r=t=>{t.creepType==this.type&&t.homeRoom==i&&(e+=t.weight)};_.forEach(Memory.population,r)}else{let i=this.globalMeasurement?Population:t.population;e=i?i.typeWeight[this.type]||0:0}return e},this.parts=function(t){let e,i=this.SelfOrCall(this._fixedBody,t),r=this.SelfOrCall(this._multiBody,t),n=this.SelfOrCall(this._minMulti,t),l=this.SelfOrCall(this._maxMulti,t),o=this.SelfOrCall(this._maxWeight,t);if(o){let i=this.existingWeight(t);e=o-i}return global.DEBUG&&global.TRACE&&trace("Setup",{setupType:this.type,room:t.name,Setup:"parts",maxWeight:e,minMulti:n,maxMulti:l}),Creep.compileBody(t,{fixedBody:i,multiBody:r,maxWeight:e,minMulti:n,maxMulti:l,currentEnergy:!0,sort:this.sortedParts})},this.mixParts=function(t){let e=_.countBy(t),i=t.filter(t=>t!=MOVE),r=[];for(let n=i.length-1;n>=0;n--)e[MOVE]-- >0&&r.unshift(MOVE),r.unshift(i[n]);for(;e[MOVE]>0;)r.unshift(MOVE),e[MOVE]--;return r},this.maxCost=function(t){let e=this;return Creep.bodyCosts(e.SelfOrCall(this._multiBody,t))*e.SelfOrCall(this._maxMulti,t)+Creep.bodyCosts(e.SelfOrCall(this._fixedBody,t))}};module.exports=t,t.isWorkingAge=function(t){const e=Game.creeps[t.creepName];return!e||(t.predictedRenewal||t.spawningTime||CREEP_LIFE_TIME)<=(e.ticksToLive||CREEP_LIFE_TIME)},t.maxPerFlag=function(e,i,r){if(!e)throw new Error("undefined flagFilter");return function(n){let l,o,s=0,a=e=>{l=routeRange(n.name,e.roomName),l>i||(o=Game.flags[e.name],_.chain(o.targetOf).filter(function(t){return!r||t.homeRoom===n.name}).every(t.isWorkingAge).value()?s++:s+=2)},u=FlagDir.filter(e);return u.forEach(a),s}},t.rclProperty=function(t){return function(e){const i=this;let r;return r="function"==typeof i.RCL?function(t){return i.RCL(t.controller.level)}:function(t){return i.RCL[t.controller.level]},void 0===t?r:i.SelfOrCall(r(e)[t],e)}};
let e={};module.exports=e,e.name="miner",e.approach=function(e){const a=new RoomPosition(e.data.determinatedSpot.x,e.data.determinatedSpot.y,e.data.homeRoom),t=e.pos.getRangeTo(a);if(t>0){e.data.movingToTarget=!0;const r=a.lookFor(LOOK_CREEPS).length?1:0;t>r&&e.travelTo(a,{range:r})}else e.data.movingToTarget&&(e.room.invalidateCostMatrix(),delete e.data.movingToTarget);return t},e.determineTarget=(e=>{let a=e=>{let a=a=>{const t=a.predictedRenewal?a.predictedRenewal:a.spawningTime;return a.determinatedTarget==e.id&&a.ttl>t},t=_.find(Memory.population,a);return!t};const t=_.find(e.room.sources,a);t&&(e.data.determinatedTarget=t.id),SAY_ASSIGNMENT&&e.say(String.fromCharCode(9935),SAY_PUBLIC)}),e.run=function(a,t={}){_.isUndefined(t.approach)&&(t.approach=e.approach),_.isUndefined(t.determineTarget)&&(t.determineTarget=e.determineTarget);let r;if(a.data.determinatedTarget?r=Game.getObjectById(a.data.determinatedTarget):t.determineTarget(a),r){if(a.action&&"harvesting"===a.action.name||Population.registerAction(a,Creep.action.harvesting,r),!a.data.determinatedSpot){let e=[],n=t=>{const r=t.predictedRenewal?t.predictedRenewal:t.spawningTime;t.roomName===a.pos.roomName&&["miner","upgrader"].includes(t.creepType)&&t.determinatedSpot&&t.ttl>r&&e.push(t.determinatedSpot)};_.forEach(Memory.population,n);const i=r.container&&r.container.pos.isNearTo(r)&&!_.some(e,{x:r.container.pos.x,y:r.container.pos.y})?r.container.pos:null;let o,d=[];if(i||(o={spots:[{pos:r.pos,range:1}],checkWalkable:!0,where:a=>!_.some(e,{x:a.x,y:a.y}),roomName:a.pos.roomName},r.container&&o.spots.push({pos:r.container.pos,range:1}),!t.remote&&r.link&&o.spots.push({pos:r.link.pos,range:1}),d=Room.fieldsInRange(o)),i||d.length>0){let e=i;if(e||(e=a.pos.findClosestByPath(d,{filter:e=>{return!_.some(a.room.lookForAt(LOOK_STRUCTURES,e),{structureType:STRUCTURE_ROAD})}})),e||(e=a.pos.findClosestByPath(d)||d[0]),e){if(a.data.determinatedSpot={x:e.x,y:e.y},!t.remote){let t=Game.spawns[a.data.motherSpawn];if(t){let r=e.findPathTo(t,{ignoreCreeps:!0});r&&(a.data.predictedRenewal=a.data.spawningTime+r.length)}}if(MINERS_AUTO_BUILD&&!r.container){const a=_.filter(r.pos.findInRange(FIND_CONSTRUCTION_SITES,2),e=>e.structureType===STRUCTURE_CONTAINER);!a.length&&r.room&&r.room.createConstructionSite(e,STRUCTURE_CONTAINER)}}}a.data.determinatedSpot||logError("Unable to determine working location for miner in room "+a.pos.roomName)}if(a.data.determinatedSpot){const e=t.approach(a),n=e=>e.data.body&&e.data.body.work?2*e.data.body.work:e.carryCapacity/2;if(0===r.energy){const e=a.data.body&&a.data.body.work?5*a.data.body.work:a.carryCapacity/2;if(a.carry.energy<=e){const e=a.pos.findInRange(FIND_DROPPED_ENERGY,1);if(e.length)CHATTY&&a.say("picking",SAY_PUBLIC),a.pickup(e[0]);else if(r.container&&r.container.sum>0)CHATTY&&a.say("withdraw cont",SAY_PUBLIC),a.withdraw(r.container,RESOURCE_ENERGY);else if(!t.remote&&r.link&&r.link.energy>0)CHATTY&&a.say("withdraw link",SAY_PUBLIC),a.withdraw(r.link,RESOURCE_ENERGY);else if(0===a.carry.energy)return void(CHATTY&&a.say("waiting",SAY_PUBLIC));if(0===a.carry.energy)return}if(a.data.repairTarget||!a.data.repairChecked||Game.time-a.data.repairChecked>MINER_WORK_THRESHOLD){let e=Game.getObjectById(a.data.repairTarget);if(!e||e.hits===e.hitsMax){const t=a.pos.findInRange(FIND_STRUCTURES,3,{filter:e=>(e.structureType===STRUCTURE_CONTAINER||e.structureType===STRUCTURE_ROAD)&&e.hits<e.hitsMax});t.length?(e=t[0],a.data.repairTarget=e.id):e=null}if(e)return CHATTY&&a.say("repairing",SAY_PUBLIC),a.repair(e);delete a.data.repairTarget,a.data.repairChecked=Game.time}if(a.data.buildTarget||!a.data.buildChecked||Game.time-a.data.buildChecked>MINER_WORK_THRESHOLD){let e=Game.getObjectById(a.data.buildTarget);if(!e||e.progress===e.progressMax){const t=a.pos.findInRange(a.room.myConstructionSites,3,{filter:e=>(e.structureType===STRUCTURE_CONTAINER||e.structureType===STRUCTURE_ROAD)&&e.progress<e.progressMax});t.length?(e=t[0],a.data.buildTarget=e.id):e=null}if(e)return CHATTY&&a.say("building",SAY_PUBLIC),a.build(e);delete a.data.buildTarget,a.data.buildChecked=Game.time}return void(CHATTY&&a.say("waiting",SAY_PUBLIC))}if(!t.remote&&r.link&&r.link.energy<r.link.energyCapacity){if(CHATTY&&a.say("harvesting",SAY_PUBLIC),0===e)return a.carry.energy>a.carryCapacity-(a.data.body&&a.data.body.work?2*a.data.body.work:a.carryCapacity/2)&&a.transfer(r.link,RESOURCE_ENERGY),a.harvest(r)}else if(r.container&&r.container.sum<r.container.storeCapacity){if(CHATTY&&a.say("harvesting",SAY_PUBLIC),0===e){if(a.sum>a.carryCapacity-n(a)){let e=e=>{a.carry[e]>0&&a.transfer(r.container,e)};_.forEach(Object.keys(a.carry),e)}return a.harvest(r)}}else if(CHATTY&&a.say("dropmining",SAY_PUBLIC),0===e){if(a.sum>a.carryCapacity-n(a)){OOPS&&a.say(String.fromCharCode(8681),SAY_PUBLIC);let e=e=>{a.carry[e]>0&&a.drop(e)};_.forEach(Object.keys(a.carry),e)}return a.harvest(r)}}else if(a.pos.getRangeTo(r)>3)return a.data.travelRange=3,Creep.action.travelling.assign(a,r)}};
const e="#000000",t="#FFFFFF",o="#FF0000",n="#00FF00",i="#FFFF00",r="#00FFFF",s=(e,t)=>{const o=t?e:1-e,n=(120*o).toString(10);return`hsl(${n}, 100%, 50%)`},a=e=>{const n={[RESOURCE_ENERGY]:"#FFE56D",[RESOURCE_POWER]:o,[RESOURCE_CATALYST]:"#FF7A7A",[RESOURCE_GHODIUM]:t,[RESOURCE_HYDROGEN]:"#CCCCCC",[RESOURCE_KEANIUM]:"#9370FF",[RESOURCE_LEMERGIUM]:"#89F4A5",[RESOURCE_OXYGEN]:"#CCCCCC",[RESOURCE_UTRIUM]:"#88D6F7",[RESOURCE_ZYNTHIUM]:"#F2D28B"};let i=n[e];if(i)return i;let r=[RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_GHODIUM,RESOURCE_HYDROGEN,RESOURCE_OXYGEN].find(t=>e.includes(t));return n[r]},c=(e,t,o,n)=>{Object.keys(t).forEach(i=>e.text(`${i}: ${Util.formatNumber(t[i])}`,o,n+=.6,Object.assign({color:a(i)},{align:"left",font:.5})))},l=class{drawBar(e,t,o,n,i,r,s,a={}){s||(s=t);const c=n+.75;e.rect(o,n,i,r,this.barStyle),e.rect(o,n,i*t,r,a),e.text(s,o+i/2,c)}drawPie(o,n,i,r,s,a,c){c||(c=n);let l=1;0!==i&&(l=n/i);a={x:a.x,y:1*a.y*4.5},o.circle(a,{radius:1.1,fill:e,stroke:"rgba(255, 255, 255, 0.8)"});const m=[a],S=2*Math.PI,u=S*(l+.1),f=-Math.PI/2,I=S/32;for(let p=0;p<=u;p+=I)m.push({x:a.x+Math.cos(p+f),y:a.y-Math.cos(p)});m.push(a),o.poly(m,{fill:s,opacity:1,stroke:s,strokeWidth:.05}),o.text(Number.isFinite(c)?Util.formatNumber(c):c,a.x,a.y+.33,{color:t,font:"1 monospace",align:"center",stroke:"rgba(0, 0, 0, 0.8)",strokeWidth:.08});let h=.7;.35<l&&l<.65&&(h+=.3),o.text(r,a.x,a.y+1+h,{color:t,font:"0.6 monospace",align:"center"});const R=m[m.length-2];o.text(""+Math.floor(100*l)+"%",R.x+.7*(R.x-a.x),R.y+.4*(R.y-a.y)+.1,{color:t,font:"0.4 monospace",align:"center"})}drawLine(e,t,o){if(e instanceof RoomObject&&(e=e.pos),t instanceof RoomObject&&(t=t.pos),!(e instanceof RoomPosition||t instanceof RoomPosition))throw new Error("Visuals: Point not a RoomPosition");if(e.roomName===t.roomName){const n=new RoomVisual(e.roomName);o=o instanceof Creep?this.creepPathStyle(o):o||{},n.line(e,t,o)}}drawArrow(e,t,o){if(e instanceof RoomObject&&(e=e.pos),t instanceof RoomObject&&(t=t.pos),!(e instanceof RoomPosition||t instanceof RoomPosition))throw new Error("Visuals: Point not a RoomPosition");if(e.roomName===t.roomName){const n=new RoomVisual(e.roomName);this.drawLine(e,t,o);const i=e.x-t.x,r=e.y-t.y,s=Math.atan2(r,i),a=.5*Math.log1p(Util.getDistance(e,t));o=o instanceof Creep?this.creepPathStyle(o):o||{},n.line(t.x,t.y,t.x+a*Math.cos(s+.610865),t.y+a*Math.sin(s+.610865),o),n.line(t.x,t.y,t.x+a*Math.cos(s-.610865),t.y+a*Math.sin(s-.610865),o)}}constructor(){this.barStyle={fill:"#2B2B2B",opacity:.8,stroke:e},this.sparklineStyle=[{key:"limit",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#808080",opacity:.25},{key:"cpu",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:i,opacity:.5},{key:"bucket",min:0,max:1e4,stroke:r,opacity:.5}],this.toolTipStyle={align:"left",font:.4},this.weakestStyle={radius:.4,fill:o,opacity:.3,strokeWidth:0},this.vis=new RoomVisual}run(){const e=Util.startProfiling("Visuals",{enabled:PROFILING.VISUALS}),t=VISUALS.VISIBLE_ONLY,o=t?Util.getVisibleRooms():Object.keys(Game.rooms);_.forEach(o,e=>{const o=Game.rooms[e];if(o&&(ROOM_VISUALS_ALL||o.my)&&(t||o.controller)){const e=Util.startProfiling("Visuals: "+o.name,{enabled:PROFILING.VISUALS});if(Util.set(Memory,"heatmap",!1),VISUALS.HEATMAP&&(Game.time%VISUALS.HEATMAP_INTERVAL===0&&(this.setHeatMapData(o),e.checkCPU("Heatmap.set",PROFILING.VISUALS_LIMIT)),Memory.heatmap))return this.drawHeatMapData(o),void e.checkCPU("Heatmap.draw",PROFILING.VISUALS_LIMIT);if(VISUALS.ROOM&&(this.drawRoomInfo(o,VISUALS.ROOM_GLOBAL),e.checkCPU("Room Info",PROFILING.VISUALS_LIMIT)),VISUALS.ROOM_ORDERS&&(this.drawRoomOrders(o),e.checkCPU("Room Orders",PROFILING.VISUALS_LIMIT)),VISUALS.ROOM_OFFERS&&(this.drawRoomOffers(o),e.checkCPU("Room Offers",PROFILING.VISUALS_LIMIT)),VISUALS.CONTROLLER&&(this.drawControllerInfo(o.controller),e.checkCPU("Controller",PROFILING.VISUALS_LIMIT)),VISUALS.SPAWN&&(o.structures.spawns.filter(e=>e.spawning).forEach(e=>this.drawSpawnInfo(e)),e.checkCPU("Spawns",PROFILING.VISUALS_LIMIT)),VISUALS.MINERAL){let[t]=o.minerals;t&&(this.drawMineralInfo(t),e.checkCPU("Mineral",PROFILING.VISUALS_LIMIT))}VISUALS.SOURCE&&(o.sources.forEach(e=>this.drawSourceInfo(e)),e.checkCPU("Sources",PROFILING.VISUALS_LIMIT)),VISUALS.WALL&&(this.highlightWeakest(o,STRUCTURE_WALL),e.checkCPU("Walls",PROFILING.VISUALS_LIMIT)),VISUALS.RAMPART&&(this.highlightWeakest(o,STRUCTURE_RAMPART),e.checkCPU("Ramparts",PROFILING.VISUALS_LIMIT)),VISUALS.ROAD&&(this.highlightWeakest(o,STRUCTURE_ROAD),e.checkCPU("Roads",PROFILING.VISUALS_LIMIT)),VISUALS.STORAGE&&(this.drawStorageInfo(o.storage),e.checkCPU("Storage",PROFILING.VISUALS_LIMIT)),VISUALS.TERMINAL&&(this.drawTerminalInfo(o.terminal),e.checkCPU("Terminal",PROFILING.VISUALS_LIMIT)),VISUALS.TRANSACTIONS&&(this.drawTransactions(o),e.checkCPU("Transactions",PROFILING.VISUALS_LIMIT)),VISUALS.LABS&&(o.structures.labs.all.forEach(e=>this.drawLabInfo(e)),e.checkCPU("Labs",PROFILING.VISUALS_LIMIT)),VISUALS.CREEP&&(o.creeps.forEach(e=>this.drawCreepPath(e)),e.checkCPU("Creep Paths",PROFILING.VISUALS_LIMIT)),VISUALS.TOWER&&(o.structures.towers.forEach(e=>this.drawTowerInfo(e)),e.checkCPU("Towers",PROFILING.VISUALS_LIMIT))}}),e.checkCPU("Total for all rooms",PROFILING.VISUALS_LIMIT),VISUALS.ROOM_GLOBAL&&(VISUALS.CPU&&(this.collectSparklineStats(),e.checkCPU("CPU Sparklines",PROFILING.VISUALS_LIMIT)),this.drawGlobal(),e.checkCPU("Global",PROFILING.VISUALS_LIMIT))}drawGlobal(){const e=this.vis,o=1;if(VISUALS.INFO_PIE_CHART){let o=2,n=.5;this.drawPie(e,Math.round(Game.gcl.progress),Game.gcl.progressTotal,`GCL ${Game.gcl.level}`,s(Game.gcl.progress/Game.gcl.progressTotal,!0),{x:o,y:n++});const i=Game.cpu.getUsed()/Game.cpu.limit,r=Math.min(1,i);this.drawPie(e,Math.round(Game.cpu.getUsed()),Game.cpu.limit,"CPU",s(r),{x:o,y:n++}),this.drawPie(e,Game.cpu.bucket,1e4,"Bucket",s(Math.min(1,Game.cpu.bucket/1e4),!0),{x:o,y:n++});const a=_.size(Game.spawns);let c=_(Game.spawns).filter("spawning").size();c+=_(Game.rooms).map(e=>e.spawnQueueHigh.concat(e.spawnQueueMedium,e.spawnQueueLow)).flatten().size();const l=c/a;this.drawPie(e,l,1,"SCU",s(l),{x:o,y:n++}),n+=15,e.text("Tick",o,n++,{color:t,align:"center"}),e.text(Game.time,o,n++,{color:t,align:"center"})}else{const t=9.8,n=this.barStyle;let i=o,r=2;const a=r-.75;if(VISUALS.ROOM){i=11.8;const o=Game.gcl.progress/Game.gcl.progressTotal;this.drawBar(e,o,i,a,t,1,`GCL: ${Game.gcl.level} (${(100*o).toFixed(2)}%)`,{fill:s(o,!0),opacity:n.opacity}),i+=10.8;const c=Game.cpu.getUsed()/Game.cpu.limit,l=Math.min(1,c);this.drawBar(e,l,i,a,t,1,`CPU: ${(100*c).toFixed(2)}%`,{fill:s(l),opacity:n.opacity}),i+=10.8;const m=Math.min(1,Game.cpu.bucket/1e4);this.drawBar(e,m,i,a,t,1,`Bucket: ${Game.cpu.bucket}`,{fill:s(m,!0),opacity:n.opacity}),i+=10.8,e.text(`Tick: ${Game.time}`,i,r,{align:"left"}),i=11.8,r+=1.5;const S=_.size(Game.spawns);let u=_(Game.spawns).filter("spawning").size();u+=_(Game.rooms).map(e=>e.spawnQueueHigh.concat(e.spawnQueueMedium,e.spawnQueueLow)).flatten().size();const f=u/S;this.drawBar(e,Math.min(1,f),i,r-.75,t,1,`SCU: ${(100*f).toFixed(2)}%`,{fill:s(Math.min(1,f)),opacity:n.opacity})}}VISUALS.CPU&&this.drawSparkline(void 0,1.5,46.5,20,2,_.map(Memory.visualStats.cpu,(e,t)=>Memory.visualStats.cpu[t]),this.sparklineStyle)}collectSparklineStats(){Util.set(Memory,"visualStats.cpu",[]),Memory.visualStats.cpu.push({limit:Game.cpu.limit,bucket:Game.cpu.bucket,cpu:Game.cpu.getUsed()}),Memory.visualStats.cpu.length>=100&&Memory.visualStats.cpu.shift()}drawSparkline(e,t,o,n,i,r,s){const a=e?new RoomVisual(e):this.vis;_.forEach(s,e=>{a.poly(_.map(r,(s,a)=>[t+n*(a/(r.length-1)),o+i*(1-(s[e.key]-e.min)/(e.max-e.min))]),e)})}drawRoomInfo(e){const t=new RoomVisual(e.name);let o,n=0;t.text(`Room: ${t.roomName}`,24.5,++n);const i=1;if(VISUALS.INFO_PIE_CHART){let o=2,n=.5;VISUALS.ROOM_GLOBAL&&(o+=4);let i,r,a,c="RCL";if(8===e.controller.level?(i=1,r=1,a=" "):e.controller.reservation?(i=e.controller.reservation.ticksToEnd,r=5e3):e.controller.owner?(i=Math.min(e.controller.progress,e.controller.progressTotal),r=e.controller.progressTotal,c+=` ${e.controller.level}`):(i=0,r=1,a="N/A"),this.drawPie(t,i,r,c,s(i/r,!0),{x:o,y:n++},a),!e.controller.reservation&&e.controller.owner){const i=e.energyAvailable/e.energyCapacityAvailable||0;this.drawPie(t,e.energyAvailable,e.energyCapacityAvailable,"Energy",s(i,!0),{x:o,y:n++})}}else{const r=9.8,a=this.barStyle;o=i,n++;let c,l;if(8===e.controller.level?(l=1,c="RCL: 8"):e.controller.reservation?(l=0,c=`Reserved: ${e.controller.reservation.ticksToEnd}`):e.controller.owner?(l=Math.min(1,e.controller.progress/e.controller.progressTotal),c=`RCL: ${e.controller.level} (${(100*l).toFixed(2)}%)`):(l=0,c=`Unowned`),this.drawBar(t,l,o,n-.75,r,1,c,{fill:s(l,!0),opacity:a.opacity}),VISUALS.ROOM_GLOBAL?(n+=1.5,o=i):o+=10.8,!e.controller.reservation&&e.controller.owner){const i=e.energyAvailable/e.energyCapacityAvailable||0;this.drawBar(t,i,o,n-.75,r,1,`Energy: ${e.energyAvailable}/${e.energyCapacityAvailable} (${(100*i).toFixed(2)}%)`,{fill:s(i,!0),opacity:a.opacity})}}}drawSpawnInfo(e){if(e.spawning){const t=new RoomVisual(e.room.name);t.text(`${e.spawning.name} (${((e.spawning.needTime-e.spawning.remainingTime)/e.spawning.needTime*100).toFixed(1)}%)`,e.pos.x+1,e.pos.y-.5,this.toolTipStyle)}}drawMineralInfo(e){const t=new RoomVisual(e.room.name),o=e.pos.x+1,n=e.pos.y-.5;e.mineralAmount?t.text(`Amount: ${Util.formatNumber(e.mineralAmount)}`,o,n,this.toolTipStyle):t.text(`Regen: ${Util.formatNumber(e.ticksToRegeneration)}`,o,n,this.toolTipStyle)}drawSourceInfo(e){const t=new RoomVisual(e.room.name),o=e.pos.x+1,n=e.pos.y-.5;e.energy?t.text(`Amount: ${e.energy}`,o,n,this.toolTipStyle):t.text(`Regen: ${e.ticksToRegeneration}`,o,n,this.toolTipStyle)}drawControllerInfo(e){const t=new RoomVisual(e.room.name),n=e.pos.x+1;let i=e.pos.y-.5;const r=this.toolTipStyle;let s=`L: ${e.level}`,a=`P: ${Util.formatNumber(e.progress)}/${Util.formatNumber(e.progressTotal)} (${(e.progress/e.progressTotal*100).toFixed(2)}%)`,c=`D: ${Util.formatNumber(e.ticksToDowngrade)}`;if(8===e.level)a=void 0;else if(e.reservation)s="L: Reserved",a=`P: ${e.reservation.username}`,c=`D: ${e.reservation.ticksToEnd}`;else if(!e.owner)return;if(t.text(s,n,i,r),a&&t.text(a,n,i+=.4,r),e.ticksToDowngrade<CONTROLLER_DOWNGRADE[e.level]||e.reservation){let e=Object.assign({},r,{color:o});t.text(c,n,i+=.4,e)}}highlightWeakest(e,t){const o=new RoomVisual(e.name),n=_(e.find(FIND_STRUCTURES)).filter({structureType:t}).min("hits");if(n&&n.pos){o.circle(n.pos.x,n.pos.y,this.weakestStyle);let e=n.pos.y-.5;const t=n.pos.lookFor(LOOK_STRUCTURES),i=_.find(t,e=>e instanceof StructureTower);if(i&&VISUALS.TOWER)e+=.4;else{const o=_.find(t,e=>e instanceof StructureSpawn&&e.spawning);if(o&&VISUALS.SPAWN)e+=.4;else{const o=_.find(t,e=>e instanceof StructureLab);o&&VISUALS.LABS&&(o.energy&&(e+=.4),o.mineralAmount&&(e+=.4),o.cooldown&&(e+=.4))}}o.text(`H: ${Util.formatNumber(n.hits)} (${(n.hits/n.hitsMax*100).toFixed(2)}%)`,n.pos.x+1,e,this.toolTipStyle)}}drawRoomOrders(e){const t=new RoomVisual(e.name),o=43;let n=VISUALS.INFO_PIE_CHART?.5:4.5;if(e.memory.resources&&e.memory.resources.orders&&_.size(e.memory.resources.orders)){VISUALS.STORAGE&&e.storage&&(n+=2+.6*_.size(e.storage.store)),VISUALS.TERMINAL&&e.terminal&&(n+=2+.6*_.size(e.terminal.store)),t.text("Room Orders",o,++n,{align:"left"});for(let i of e.memory.resources.orders)t.text(`${i.type}: ${Util.formatNumber(i.amount)}`,o,n+=.6,Object.assign({color:a(i.type)},this.toolTipStyle))}}drawRoomOffers(e){const t=new RoomVisual(e.name),o=43;let n=VISUALS.INFO_PIE_CHART?.5:4.5;if(e.memory.resources&&e.memory.resources.offers&&_.size(e.memory.resources.offers)){VISUALS.STORAGE&&e.storage&&(n+=2+.6*_.size(e.storage.store)),VISUALS.TERMINAL&&e.terminal&&(n+=2+.6*_.size(e.terminal.store)),VISUALS.ROOM_ORDERS&&e.memory.resources.orders&&(n+=2+.6*_.size(e.memory.resources.orders)),t.text("Room Offerings",o,++n,{align:"left"});for(let i of e.memory.resources.offers)t.text(`${i.type}: ${Util.formatNumber(i.amount)} (to ${i.room})`,o,n+=.6,Object.assign({color:a(i.type)},this.toolTipStyle))}}drawStorageInfo(e){if(e&&_.size(e.store)){const t=new RoomVisual(e.room.name),o=43;let n=VISUALS.INFO_PIE_CHART?.5:4.5;t.text("Storage Contents",o,++n,{align:"left"}),c(t,e.store,o,n)}}drawTerminalInfo(e){if(e&&_.size(e.store)){const t=new RoomVisual(e.room.name),o=43;let n=VISUALS.INFO_PIE_CHART?.5:4.5;VISUALS.STORAGE&&e.room.storage&&(n+=2+.6*_.size(e.room.storage.store)),t.text("Terminal Contents",o,++n,{align:"left"}),c(t,e.store,o,n)}}drawTransactions(e){if(e.terminal){const t=new RoomVisual(e.name),i=e.terminal.pos.x;let r=e.terminal.pos.y-1;const s=_(Game.market.incomingTransactions).concat(Game.market.outgoingTransactions).filter(t=>t.from===e.name||t.to===e.name).sortByOrder("time","desc").slice(0,2).value();0!==s.length&&(2===s.length&&(r-=.4),s.forEach(s=>{const a=s.sender.username===e.controller.owner.username,c=!!s.recipient&&s.sender.username===s.recipient.username,l=e.name===s.to,m=a||l?n:o,S=a?"+":"-";let u="";if(c||!s.order){const e=l?s.from:s.to;u=`${e} : ${s.amount} ${s.resourceType}`}else u=`${S}${s.amount*s.order.price}`;t.text(u,i,r,{font:this.toolTipStyle.font,color:m}),r+=.4}))}}drawLabInfo(e){const t=new RoomVisual(e.room.name);if(e.energy||e.mineralAmount||e.cooldown){const n=e.pos.x+.8;let i=e.pos.y-.5;e.energy&&t.text(`E: ${Util.formatNumber(e.energy)}`,n,i,Object.assign({color:a(RESOURCE_ENERGY)},this.toolTipStyle)),e.mineralAmount&&t.text(`M: ${e.mineralType} (${Util.formatNumber(e.mineralAmount)})`,n,i+=.4,Object.assign({color:a(e.mineralType)},this.toolTipStyle)),e.cooldown&&t.text(`C: ${e.cooldown}`,n,i+=.4,Object.assign({color:o},this.toolTipStyle))}}setHeatMapData(e){Util.set(e.memory,"heatmap",()=>{const t={};for(let o=0;o<50;o++)for(let n=0;n<50;n++){const i=e.getPositionAt(o,n);if("wall"!==Game.map.getTerrainAt(i)){const e=`${String.fromCharCode(32+o)}${String.fromCharCode(32+n)}_x${o}-y${n}`;t[e]=0}}return t}),e.creeps.filter(e=>!e.spawning).forEach(t=>{const o=t.pos.x,n=t.pos.y,i=`${String.fromCharCode(32+o)}${String.fromCharCode(32+n)}_x${o}-y${n}`;e.memory.heatmap[i]++})}drawHeatMapData(e){const t=new RoomVisual(e.name),o=Object.keys(e.memory.heatmap).map(t=>{return{n:e.memory.heatmap[t],x:t.charCodeAt(0)-32,y:t.charCodeAt(1)-32}}),n=_.filter(o,e=>e.n>0),i=_.sum(n,e=>e.n)/n.length*2;n.forEach(e=>{const o=e.n/i,n=s(Math.min(1,o));t.rect(e.x-.5,e.y-.5,1,1,{fill:n})})}drawTowerInfo(e){const t=new RoomVisual(e.room.name);t.text(`E: ${e.energy}/${e.energyCapacity}`,e.pos.x+1,e.pos.y-.5,this.toolTipStyle)}creepPathStyle(e){function t(){let e="#";for(;e.length<7;)e+=Math.random().toString(16).substr(-7).substr(-1);return e}return Util.set(e.data,"pathColour",t),{width:.15,color:e.data.pathColour,lineStyle:"dashed"}}drawCreepPath(e){const t=new RoomVisual(e.room.name);if((!e.action||"idle"!==e.action.name)&&!_(e.pos).pick(["x","y"]).eq(e.data.determinatedSpot)&&e.memory&&e.memory._travel&&e.memory._travel.path){const o=e.memory._travel.path.substr(1),n=this.creepPathStyle(e);let i=e.pos.x,r=e.pos.y;const s={[TOP]:{x:0,y:-1},[TOP_RIGHT]:{x:1,y:-1},[RIGHT]:{x:1,y:0},[BOTTOM_RIGHT]:{x:1,y:1},[BOTTOM]:{x:0,y:1},[BOTTOM_LEFT]:{x:-1,y:1},[LEFT]:{x:-1,y:0},[TOP_LEFT]:{x:-1,y:-1}};if(0===e.fatigue){const t=+e.memory._travel.path[0];i+=s[t].x,r+=s[t].y}for(let a of o)a=+a,t.line(i,r,i+=s[a].x,r+=s[a].y,n)}}};module.exports=new l;
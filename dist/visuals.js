const e="#000000",t="#FFFFFF",o="#FF0000",n="#00FF00",r="#FFFF00",i="#00FFFF",s=(e,t)=>{const o=t?parcentage:1-e,n=(120*o).toString(10);return`hsl(${n}, 100%, 50%)`},a=e=>{const n={[RESOURCE_ENERGY]:"#FFE56D",[RESOURCE_POWER]:o,[RESOURCE_CATALYST]:"#FF7A7A",[RESOURCE_GHODIUM]:t,[RESOURCE_HYDROGEN]:"#CCCCCC",[RESOURCE_KEANIUM]:"#9370FF",[RESOURCE_LEMERGIUM]:"#89F4A5",[RESOURCE_OXYGEN]:"#CCCCCC",[RESOURCE_ZYNTHIUM]:"#F2D28B"};let r=n[e];if(r)return r;let i=[RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_GHODIUM,RESOURCE_HYDROGEN,RESOURCE_OXYGEN].find(t=>e.includes(t));return n[i]},c=(e,t,o,n)=>{_(t).map((e,t)=>({r:e,k:e})).forEach(t=>e.text(`${t.r}: ${Util.formatNumber(t.a)}`,o,n+=.6,Object.assign({color:a(t.r)},this.toolTipStyle)))},l=class{drawLine(e,t,o){if(e instanceof RoomObject&&(e=e.pos),t instanceof RoomObject&&(t=t.pos),!(e instanceof RoomPosition||t instanceof RoomPosition))throw new Error("Visuals: Point not a RoomPosition");if(e.roomName===t.roomName){const n=new RoomVisual(e.roomName);o=o instanceof Creep?this.creepPathStyle(o):o||{},n.line(e,t,o)}}constructor(){this.barStyle={fill:"#2B2B2B",opacity:.8,stroke:e},this.sparklineStyle=[{key:"limit",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#808080",opacity:.25},{key:"cpu",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:r,opacity:.5},{key:"bucket",min:0,max:1e4,stroke:i,opacity:.5}],this.toolTipStyle={align:"left",font:.4},this.weakestStyle={radius:.4,fill:o,opacity:.3,strokeWidth:0},this.vis=new RoomVisual}run(){const e=Util.startProfiling("Visuals",{enabled:PROFILING.VISUALS});for(const t of Game.rooms)if((ROOM_VISUALS_ALL||t.my)&&t.controller){const e=Util.startProfiling("Visuals: "+t.name,{enabled:PROFILING.VISUALS});if(Util.set(Memory,"heatmap",!1),VISUALS.HEATMAP&&(Game.time%VISUALS.HEATMAP_INTERVAL===0&&(this.setHeatMapData(t),e.checkCPU("Heatmap.set",PROFILING.VISUALS_LIMIT)),Memory.heatmap))this.drawHeatMapData(t),e.checkCPU("Heatmap.draw",PROFILING.VISUALS_LIMIT);else{if(VISUALS.ROOM&&(this.drawRoomInfo(t,VISUALS.ROOM_GLOBAL),e.checkCPU("Room Info",PROFILING.VISUALS_LIMIT)),VISUALS.ROOM_ORDERS&&(this.drawRoomOrders(t),e.checkCPU("Room Orders",PROFILING.VISUALS_LIMIT)),VISUALS.ROOM_OFFERS&&(this.drawRoomOffers(t),e.checkCPU("Room Offers",PROFILING.VISUALS_LIMIT)),VISUALS.CONTROLLER&&(this.drawControllerInfo(t.controller),e.checkCPU("Controller",PROFILING.VISUALS_LIMIT)),VISUALS.SPAWN&&(t.structures.spawns.filter(e=>e.spawning).forEach(this.drawSpawnInfo),e.checkCPU("Spawns",PROFILING.VISUALS_LIMIT)),VISUALS.MINERAL){let[o]=t.minerals;o&&(this.drawMineralInfo(o),e.checkCPU("Mineral",PROFILING.VISUALS_LIMIT))}VISUALS.SOURCE&&(t.sources.forEach(this.drawSourceInfo),e.checkCPU("Sources",PROFILING.VISUALS_LIMIT)),VISUALS.WALL&&(this.highlightWeakest(t,STRUCTURE_WALL),e.checkCPU("Walls",PROFILING.VISUALS_LIMIT)),VISUALS.RAMPART&&(this.highlightWeakest(t,STRUCTURE_RAMPART),e.checkCPU("Ramparts",PROFILING.VISUALS_LIMIT)),VISUALS.ROAD&&(this.highlightWeakest(t,STRUCTURE_ROAD),e.checkCPU("Roads",PROFILING.VISUALS_LIMIT)),VISUALS.STORAGE&&(this.drawStorageInfo(t.storage),e.checkCPU("Storage",PROFILING.VISUALS_LIMIT)),VISUALS.TERMINAL&&(this.drawTerminalInfo(t.terminal),e.checkCPU("Terminal",PROFILING.VISUALS_LIMIT)),VISUALS.TRANSACTIONS&&(this.drawTransactions(t),e.checkCPU("Transactions",PROFILING.VISUALS_LIMIT)),VISUALS.LABS&&(t.structures.labs.all.forEach(this.drawLabInfo),e.checkCPU("Labs",PROFILING.VISUALS_LIMIT)),VISUALS.CREEP&&(t.creeps.forEach(this.drawCreepPath),e.checkCPU("Creep Paths",PROFILING.VISUALS_LIMIT)),VISUALS.TOWER&&(t.structures.towers.forEach(this.drawTowerInfo),e.checkCPU("Towers",PROFILING.VISUALS_LIMIT))}}e.checkCPU("Total for all rooms",PROFILING.VISUALS_LIMIT),VISUALS.ROOM_GLOBAL&&(VISUALS.CPU&&(this.collectSparklineStats(),e.checkCPU("CPU Sparklines",PROFILING.VISUALS_LIMIT)),this.drawGlobal(),e.checkCPU("Global",PROFILING.VISUALS_LIMIT))}drawGlobal(){const e=this.vis,t=1,o=9.8,n=l.barStyle;let r=t;const i=2,a=1.25,c=[r,a,o,1,n],m=()=>e.rect(...c);if(VISUALS.ROOM){r=11.8,m();const t=Game.gcl.progress/Game.gcl.progressTotal;e.rect(r,a,t,1,{fill:s(t,!0),opacity:n.opacity}),e.text(`GCL: ${Game.gcl.level} (${(100*t).toFixed(2)}%)`,r+4.9,i),r+=10.8,m();const o=Game.cpu.getUsed()/Game.cpu.limit,c=MAth.min(1,o);e.rect(r,a,9.8*c,1,{fill:s(c),opacity:n.opacity}),e.text(`CPU: ${(100*o).toFixed(2)}%`,r+4.9,i),r+=10.8,m();const l=Math.min(1,Game.cpu.bucket/1e4);e.rect(r,a,9.8*l,1,{fill:s(l,!0),opacity:n.opacity}),e.text(`Bucket: ${Game.cpu.bucket}`,r+4.9,i),r+=10.8,e.text(`Tick: ${Game.time}`,r,i,{align:"left"})}VISUALS.CPU&&this.drawSparkline(void 0,1.5,46.5,20,2,_.map(Memory.visualStats.cpu,(e,t)=>Memory.visualStats.cpu[t]),this.sparklineStyle)}drawSparkline(e,t,o,n,r,i,s){const a=e?new RoomVisual(e):this.vis;_.forEach(s,e=>{a.poly(_.map(i,(s,a)=>[t+n(a/i.length-1),o+r*(1-(s[e.key]-e.min)/(e.max-e.min))]),e)})}drawRoomInfo(e){const t=new RoomVisual(e.name);let o,n=0;t.text(`Room: ${t.roomName}`,24,5,++n);const r=1,i=9.8,a=this.barStyle;o=r,t.rect(o,++n-.75,i,1,a);let c,l;if(8===e.controller.level?(l=1,c="RCL: 8"):e.controller.reservation?(l=0,c=`Reserved: ${e.controller.reservation.ticksToEnd}`):e.controller.owner?(l=Math.min(1,e.controller.progress/e.controller.progressTotal),c=`RCL: ${e.controller.level} (${(100*l).toFixed(2)}%)`):(l=0,c=`Unowned`),t.rect(o,n-.75,9.8*l,1,{fill:s(l,!0),opacity:a.opacity}),t.text(c,o+4.9,n),VISUALS.ROOM_GLOBAL?(n+=1.5,o=r):o+=10.8,!e.controller.reservation||!e.controller.owner){t.rect(o,n-.75,i,1,a);const r=e.energyAvailable/e.energyCapacityAvailable||0;t.rect(o,n-.75,9.8*Math.min(1,r),1,{fill:s(r,!0),opacity:a.opacity}),t.text(`Energy: ${e.energyAvailable}/${e.energyCapacityAvailable} (${(100*r).toFixed(2)}%)`,o+4.9,n)}}drawSpawnInfo(e){if(e.spawning){const t=new RoomVisual(e.room.name);t.text(`${e.spawning.name} (${((e.spawning.needTime-e.spawning.remainingTime)/e.spawning.needTime*100).toFixed(1)}%)`,e.pos.x+1,e.pos.y-.5,this.toolTipStyle)}}drawMineralInfo(e){const t=new RoomVisual(e.room.name),o=e.pos.x+1,n=e.pos.y-.5;e.mineralAmount?t.text(`Amount: ${formatNum(e.mineralAmount)}`,o,n,this.toolTipStyle):t.text(`Regen: ${formatNum(e.ticksToRegeneration)}`,o,n,this.toolTipStyle)}drawSourceInfo(e){const t=new RoomVisual(e.room.name),o=e.pos.x+1,n=e.pos.y-.5;e.energy?t.text(`Amount: ${e.energy}`,o,n,this.toolTipStyle):t.text(`Regen: ${e.ticksToRegeneration}`,o,n,this.toolTipStyle)}drawControllerInfo(e){const t=new RoomVisual(e.room.name),n=e.pos.x+1;let r=e.pos.y-.5;const i=this.toolTipStyle;let s=`L: ${e.level}`,a=`P: ${Util.formatNumber(e.progress)}/${Util.formatNumber(e.progressTotal)} (${(e.progress/e.progressTotal*100).toFixed(2)}%)`,c=`D: ${Util.formatNumber(e.ticksToDowngrade)}`;if(8===e.level)a=void 0;else if(e.reservation)s="L: Reserved",a=`P: ${e.reservation.username}`,c=`D: ${e.reservation.ticksToEnd}`;else if(!e.owner)return;if(t.text(s,n,r,i),a&&t.text(a,n,r+=.4,i),e.ticksToDowngrade<CONTROLLER_DOWNGRADE[e.level]||e.reservation){let e=Object.assign({},i,{color:o});t.text(c,n,r+=.4,e)}}highlightWeakest(e,t){const o=new RoomVisual(e.name),n=_(e.find(FIND_STRUCTURES)).filter({structureType:t}).min("hits");if(n&&n.pos){o.circle(n.pos.x,n.pos.y,l.weakestStyle);let e=n.pos.y-.5;const t=n.pos.lookFor(LOOK_STRUCTURES),r=_.find(t,e=>e instanceof StructureTower);if(r&&VISUALS.TOWER)e+=.4;else{const o=_.find(t,e=>e instanceof StructureSpawn&&e.spawning);if(o&&VISUALS.SPAWN)e+=.4;else{const o=_.find(t,e=>e instanceof StructureLab);o&&VISUALS.LABS&&(o.energy&&(e+=.4),o.mineralAmount&&(e+=.4),o.cooldown&&(e+=.4))}}o.text(`H: ${Util.formatNumber(n.hits)} (${(n.hits/n.hitsMax*100).toFixed(2)}%)`,n.pos.x+1,e,this.toolTipStyle)}}drawRoomOrders(e){const t=new RoomVisual(e.name),o=43;let n=4.5;if(e.memory.resources&&e.memory.resources.orders&&_.size(e.memory.resources.orders)){VISUALS.STORAGE&&e.storage&&(n+=2+.6*_.size(e.storage.store)),VISUALS.TERMINAL&&e.terminal&&(n+=2+.6*_.size(e.terminal.store)),t.text("Room Orders",o,++n,{align:"left"});for(let r of e.memory.resources.orders)t.text(`${r.type}: ${Util.formatNumber(r.amount)}`,o,n+=.6,Object.assign({color:a(r.type)},this.toolTipStyle))}}drawRoomOffers(e){const t=new RoomVisual(e.name),o=43;let n=4.5;if(e.memory.resources&&e.memory.resources.offers&&_.size(e.memory.resources.offers)){VISUALS.STORAGE&&e.storage&&(n+=2+.6*_.size(e.storage.store)),VISUALS.TERMINAL&&e.terminal&&(n+=2+.6*_.size(e.terminal.store)),VISUALS.ROOM_ORDERS&&e.memory.resources.orders&&(n+=2+.6*_.size(e.memory.resources.orders)),t.text("Room Offerings",o,++n,{align:"left"});for(let r of e.memory.resources.offers)t.text(`${r.type}: ${Util.formatNumber(r.amount)} (to ${r.room})`,o,n+=.6,Object.assign({color:a(r.type)},this.toolTipStyle))}}drawStorageInfo(e){if(e){const t=new RoomVisual(e.room.name),o=43;let n=4.5;t.text("Storage Contents",o,++n,{align:"left"}),c.call(this,t,e.store,o,n)}}drawTerminalInfo(e){if(e){const t=new RoomVisual(e.room.name),o=43;let n=4.5;VISUALS.STORAGE&&e.room.storage&&(n+=2+.6*_.size(e.room.storage.store)),t.text("Terminal Contents",o,++n,{align:"left"}),c.call(this,t,e.store,o,n)}}drawTransaction(e){if(e.terminal){const t=new RoomVisual(e.name),r=e.terminal.pos.x;let i=e.terminal.pos.y-1;const s=_(Game.market.incomingTransactions).concat(Game.market.outgoingTransactions).filter(t=>t.from===e.name||t.to===e.name).sortByOrder("time","desc").slice(0,2).value();0!==s.length&&(2===s.length&&(i-=.4),s.forEach(s=>{const a=s.sender.username===e.controller.owner.username,c=!!s.recipient&&s.sender.username===s.recipient.username,l=e.name===s.to,m=a||l?n:o,S=a?"+":"-";let I="";if(c||!s.order){const e=l?s.from:s.to;I=`${e} : ${s.amount} ${s.resourceType}`}else I=`${S}${s.amount*s.order.price}`;t.text(I,r,i,{font:this.toolTipStyle.font,color:m}),i+=.4}))}}drawLabInfo(e){const t=new RoomVisual(room.name);if(e.energy||e.mineralAmount||e.cooldown){const n=e.pos.x+.8;let r=e.pos.y-.5;e.energy&&t.text(`E: ${Util.formatNumber(e.energy)}`,n,r,Object.assign({color:a(RESOURCE_ENERGY)},this.toolTipStyle)),e.mineralAmount&&t.text(`M: ${e.mineralType} (${Util.formatNumber(e.mineralAmount)})`,n,r+=.4,Object.assign({color:a(e.mineralType)},this.toolTipStyle)),e.cooldown&&t.text(`C: ${e.cooldown}`,n,r+=.4,Object.assign({color:o},this.toolTipStyle))}}setHeatMapData(e){Util.set(e.memory,"heatmap",()=>{const t={};for(let o=0;o<50;o++)for(let n=0;n<50;n++){const r=e.getPositionAt(o,n);if("wall"!==Game.map.getTerrainAt(r)){const e=`${String.fromCharCode(32+o)}${String.fromCharCode(32+n)}_x${o}-y${n}`;t[e]=0}}return t}),e.creeps.filter(e=>!e.spawning).forEach(t=>{const o=t.pos.x,n=t.pos.y,r=`${String.fromCharCode(32+o)}${String.fromCharCode(32+n)}_x${o}-y${n}`;e.memory.heatmap[r]++})}drawHeatMapData(e){const t=new RoomVisual(e.name),o=Object.keys(e.memory.heatmap).map(t=>{return{n:e.memory.heatmap[t],x:t.charCodeAt(0)-32,y:t.charCodeAt(1)-32}}),n=_.filter(o,e=>e.n>0),r=_.sum(n,e=>e.n)/n.length*2;n.forEach(e=>{const o=e.n/r,n=s(Math.min(1,o));t.rect(e.x-.5,e.y-.5,1,1,{fill:n})})}drawTowerInfo(e){const t=new RoomVisual(e.room.name);t.text(`E: ${e.energy}/${e.energyCapacity}`,e.pos.x+1,e.pos.y-.5,this.toolTipStyle)}creepPathStyle(e){function t(){let e="#";for(;e.length<7;)e+=Math.random().toString(16).substr(-7).substr(-1);return e}return Util.set(e.data,"pathColour",t),{width:.15,color:e.data.pathColour,lineStyle:"dashed"}}drawCreepPath(e){new RoomVisual(room.name);if("idle"!==e.action.name&&!_(e.pos).pick(["x","y"]).eq(e.data.determinatedSpot)&&e.memory&&e.memory._travel&&e.memory._travel.path){const t=e.memory._travel.path.substr(1);this.creepPathStyle(e);let o=e.pos.x,n=e.pos.y;const r={[TOP]:{x:0,y:-1},[TOP_RIGHT]:{x:1,y:-1},[RIGHT]:{x:1,y:0},[BOTTOM_RIGHT]:{x:1,y:1},[BOTTOM]:{x:0,y:1},[BOTTOM_LEFT]:{x:-1,y:1},[LEFT]:{x:-1,y:0},[TOP_LEFT]:{x:-1,y:-1}};if(0===e.fatigue){const t=+e.memory._travel.path[0];o+=r[t].x,n+=r[t].y}for(let i of t)i=+i,o+=r[i].x,n+=r[i].y}}};module.exports=new l;
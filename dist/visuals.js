function formatNum(e){return e>=1e6?(e/1e6).toFixed(2)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e}function storageObject(o,t,r,n){Object.keys(t).forEach(a=>o.text(`${a}: ${formatNum(t[a])}`,r,n+=.6,Object.assign({color:getResourceColour(a)},e.tooltipStyle)))}function getResourceColour(e){const o={[RESOURCE_ENERGY]:"#FFE56D",[RESOURCE_POWER]:"#FF0000",[RESOURCE_CATALYST]:"#FF7A7A",[RESOURCE_GHODIUM]:"#FFFFFF",[RESOURCE_HYDROGEN]:"#CCCCCC",[RESOURCE_KEANIUM]:"#9370FF",[RESOURCE_LEMERGIUM]:"#89F4A5",[RESOURCE_OXYGEN]:"#CCCCCC",[RESOURCE_UTRIUM]:"#88D6F7",[RESOURCE_ZYNTHIUM]:"#F2D28B"};let t=o[e];if(!t){let r=[RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_GHODIUM,RESOURCE_HYDROGEN,RESOURCE_OXYGEN].find(o=>e.indexOf(o)!==-1);t=o[r]}return t}function getColourByPercentage(e,o=false){const t=o?e:1-e,r=(120*t).toString(10);return`hsl(${r}, 100%, 50%)`}const e=class{};module.exports=e,e.extend=function(){Object.defineProperties(e,{barStyle:{configurable:!0,value:{fill:"#2B2B2B",opacity:.8,stroke:"#000000"}},sparklineStyle:{configurable:!0,value:[{key:"limit",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#808080",opacity:.25},{key:"cpu",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#FFFF00",opacity:.5},{key:"bucket",min:0,max:1e4,stroke:"#00FFFF",opacity:.5}]},tooltipStyle:{configurable:!0,value:{align:"left",font:.4}},weakestStyle:{configurable:!0,value:{radius:.4,fill:"#FF0000",opacity:.3,strokeWidth:0}}}),e.drawGlobal=function(){const o=new RoomVisual,t=1,r=9.8,n=e.barStyle;let a=t;const i=2;if(VISUALS.ROOM){a=11.8,o.rect(a,1.25,r,1,n);const e=Game.gcl.progress/Game.gcl.progressTotal;o.rect(a,1.25,9.8*e,1,{fill:getColourByPercentage(e,!0),opacity:n.opacity}),o.text(`GCL: ${Game.gcl.level} (${(100*e).toFixed(2)}%)`,a+4.9,i),a+=10.8,o.rect(a,1.25,r,1,n);const t=Game.cpu.getUsed()/Game.cpu.limit,s=Math.min(1,t);o.rect(a,1.25,9.8*s,1,{fill:getColourByPercentage(s),opacity:n.opacity}),o.text(`CPU: ${(100*t).toFixed(2)}%`,a+4.9,i),a+=10.8,o.rect(a,1.25,r,1,n);const l=Game.cpu.bucket/1e4;o.rect(a,1.25,9.8*l,1,{fill:getColourByPercentage(l,!0),opacity:n.opacity}),o.text(`Bucket: ${Game.cpu.bucket}`,a+4.9,i),a+=10.8,o.text(`Tick: ${Game.time}`,a,i,{align:"left"})}VISUALS.CPU&&e.drawSparkline(void 0,1.5,46.5,20,2,_.map(Memory.visualStats.cpu,(e,o)=>Memory.visualStats.cpu[o]),e.sparklineStyle)},e.drawSparkline=function(e,o,t,r,n,a,i){const s=e?new RoomVisual(e):new RoomVisual;_.forEach(i,e=>{s.poly(_.map(a,(i,s)=>[o+r*(s/(a.length-1)),t+n*(1-(i[e.key]-e.min)/(e.max-e.min))]),e)})},e.collectSparklineStats=function(){_.get(Memory,"visualStats.cpu")||_.set(Memory,"visualStats.cpu",[]),Memory.visualStats.cpu.push({limit:Game.cpu.limit,bucket:Game.cpu.bucket,cpu:Game.cpu.getUsed()}),Memory.visualStats.cpu.length>=100&&Memory.visualStats.cpu.shift()},e.drawRoomInfo=function(o){const t=new RoomVisual(o.name);let r,n=0;t.text(`Room: ${t.roomName}`,24.5,++n);const a=1,i=9.8,s=e.barStyle;r=a,t.rect(r,++n-.75,i,1,s);let l,c;if(8===o.controller.level?(c=1,l=`RCL: 8`):o.controller.reservation?(c=0,l=`Reserved: ${o.controller.reservation.ticksToEnd}`):o.controller.owner?(c=o.controller.progress/o.controller.progressTotal,l=`RCL: ${o.controller.level} (${(100*c).toFixed(2)}%)`):(c=0,l=`Unowned`),c=Math.min(1,c),t.rect(r,n-.75,9.8*c,1,{fill:getColourByPercentage(c,!0),opacity:s.opacity}),t.text(l,r+4.9,n),VISUALS.ROOM_GLOBAL?(n+=1.5,r=a):r+=10.8,!o.controller.reservation){t.rect(r,n-.75,i,1,s);const e=o.energyAvailable/o.energyCapacityAvailable||0;t.rect(r,n-.75,9.8*Math.min(1,e),1,{fill:getColourByPercentage(e,!0),opacity:s.opacity}),t.text(`Energy: ${o.energyAvailable}/${o.energyCapacityAvailable} (${(100*e).toFixed(2)}%)`,r+4.9,n)}},e.drawSpawnInfo=function(o){if(o.spawning){const t=new RoomVisual(o.room.name);t.text(`${o.spawning.name} (${((o.spawning.needTime-o.spawning.remainingTime)/o.spawning.needTime*100).toFixed(1)}%)`,o.pos.x+1,o.pos.y-.5,e.tooltipStyle)}},e.drawMineralInfo=function(o){const t=new RoomVisual(o.room.name);let r=o.pos.x+1,n=o.pos.y-.5;o.mineralAmount?t.text(`Amount: ${formatNum(o.mineralAmount)}`,r,n,e.tooltipStyle):t.text(`Regen: ${formatNum(o.ticksToRegeneration)}`,r,n,e.tooltipStyle)},e.drawSourceInfo=function(o){const t=new RoomVisual(o.room.name);let r=o.pos.x+.5,n=o.pos.y-.5;o.energy?t.text(`Amount: ${o.energy}`,r,n,e.tooltipStyle):t.text(`Regen: ${o.ticksToRegeneration}`,r,n,e.tooltipStyle)},e.drawControllerInfo=function(o){const t=new RoomVisual(o.room.name),r=o.pos.x+1;let n=o.pos.y-.5;const a=e.tooltipStyle;let i=`L: ${o.level}`,s=`P: ${formatNum(o.progress)}/${formatNum(o.progressTotal)} (${(o.progress/o.progressTotal*100).toFixed(2)}%)`,l=`D: ${formatNum(o.ticksToDowngrade)}`;if(8===o.level)s=void 0;else if(o.reservation)i="L: Reserved",s=`P: ${o.reservation.username}`,l=`D: ${o.reservation.ticksToEnd}`;else if(!o.owner)return;if(t.text(i,r,n,a),s&&t.text(s,r,n+=.4,a),o.ticksToDowngrade<CONTROLLER_DOWNGRADE[o.level]||o.reservation){let e=Object.assign({},a,{color:"#FF0000"});t.text(l,r,n+=.4,e)}},e.highlightWeakest=function(o,t){const r=new RoomVisual(o.name);let n=_(o.find(FIND_STRUCTURES)).filter(e=>e.structureType===t).min(e=>e.hits);if(n&&n.pos){r.circle(n.pos.x,n.pos.y,e.weakestStyle);let o=n.pos.y-.5;const t=n.pos.lookFor(LOOK_STRUCTURES),a=_.find(t,e=>e instanceof StructureTower);if(a&&VISUALS.TOWER)o+=.4;else{const e=_.find(t,e=>e instanceof StructureSpawn&&e.spawning);if(e&&VISUALS.SPAWN)o+=.4;else{const e=_.find(t,e=>e instanceof StructureLab);e&&VISUALS.LABS&&(e.energy&&(o+=.4),e.mineralAmount&&(o+=.4),e.cooldown&&(o+=.4))}}r.text(`H: ${formatNum(n.hits)} (${(n.hits/n.hitsMax*100).toFixed(2)}%)`,n.pos.x+1,o,e.tooltipStyle)}},e.drawRoomOrders=function(o){const t=new RoomVisual(o.name),r=43;let n=4.5;if(o.memory.resources&&o.memory.resources.orders){VISUALS.STORAGE&&o.storage&&(n+=2+.6*_.size(o.storage.store)),VISUALS.TERMINAL&&o.terminal&&(n+=2+.6*_.size(o.terminal.store)),t.text("Room Orders",r,++n,{align:"left"});for(let a of o.memory.resources.orders)t.text(`${a.type}: ${formatNum(a.amount)}`,r,n+=.6,Object.assign({color:getResourceColour(a.type)},e.tooltipStyle))}},e.drawRoomOffers=function(o){const t=new RoomVisual(o.name),r=43;let n=4.5;if(o.memory.resources&&o.memory.resources.offers){VISUALS.STORAGE&&o.storage&&(n+=2+.6*_.size(o.storage.store)),VISUALS.TERMINAL&&o.terminal&&(n+=2+.6*_.size(o.terminal.store)),VISUALS.ROOM_ORDERS&&o.memory.resources.orders&&(n+=2+.6*_.size(o.memory.resources.orders)),t.text("Room Offerings",r,++n,{align:"left"});for(let a of o.memory.resources.offers)t.text(`${a.type}: ${formatNum(a.amount)} (to ${a.room})`,r,n+=.6,Object.assign({color:getResourceColour(a.type)},e.tooltipStyle))}},e.storage=function(e){if(e.storage){const o=new RoomVisual(e.name),t=43;let r=4.5;o.text("Storage Contents",t,++r,{align:"left"}),storageObject(o,e.storage.store,t,r)}},e.terminal=function(e){if(e.terminal){const o=new RoomVisual(e.name),t=43;let r=4.5;VISUALS.STORAGE&&e.storage&&(r+=2+.6*_.size(e.storage.store)),o.text("Terminal Contents",t,++r,{align:"left"}),storageObject(o,e.terminal.store,t,r)}},e.drawTowerInfo=function(o){const t=new RoomVisual(o.room.name);t.text(`E: ${o.energy}/${o.energyCapacity}`,o.pos.x+1,o.pos.y-.5,e.tooltipStyle)},e.drawTransactions=function(o){if(o.terminal){const t=new RoomVisual(o.name),r=o.terminal.pos.x;let n=o.terminal.pos.y-1;const a=_(Game.market.incomingTransactions).concat(Game.market.outgoingTransactions).filter(e=>e.from===o.name||e.to===o.name).sortBy("time").reverse().slice(0,2).value();if(0===a.length)return;2===a.length&&(n-=.4),a.forEach(a=>{const i=a.sender.username===o.controller.owner.username,s=!!a.recipient&&a.sender.username===a.recipient.username,l=o.name===a.to,c=i||l?"#00FF00":"#FF0000",m=i?"+":"-";let u="";if(s||!a.order){const e=l?a.from:a.to;u=`${e} : ${a.amount} ${a.resourceType}`}else u=`${m}${a.amount*a.order.price}`;t.text(u,r,n,{font:e.tooltipStyle.font,color:c}),n+=.4})}},e.drawLabs=function(o){const t=new RoomVisual(o.name);for(let r of o.structures.labs.all)if(r.energy||r.mineralAmount||r.cooldown){const o=r.pos.x+.8;let n=r.pos.y-.5;r.energy&&t.text(`E: ${formatNum(r.energy)}`,o,n,Object.assign({color:getResourceColour(RESOURCE_ENERGY)},e.tooltipStyle)),r.mineralAmount&&t.text(`M: ${r.mineralType} (${formatNum(r.mineralAmount)})`,o,n+=.4,Object.assign({color:getResourceColour(r.mineralType)},e.tooltipStyle)),r.cooldown&&t.text(`C: ${r.cooldown}`,o,n+=.4,Object.assign({color:"#FF0000"},e.tooltipStyle))}},e.setHeatMapData=function(e){if(void 0===e.memory.heatmap){e.memory.heatmap={};for(let o=0;o<50;o++)for(let t=0;t<50;t++){const r=e.lookForAt(LOOK_TERRAIN,o,t);if(!r||"wall"!==r[0]){const r=`${String.fromCharCode(32+o)}${String.fromCharCode(32+t)}_x${o}-y${t}`;e.memory.heatmap[r]=0}}}e.creeps.filter(e=>!e.spawning).forEach(o=>{const t=o.pos.x,r=o.pos.y,n=`${String.fromCharCode(32+t)}${String.fromCharCode(32+r)}_x${t}-y${r}`;e.memory.heatmap[n]++})},e.drawHeatMapData=function(e){const o=new RoomVisual(e.name),t=Object.keys(e.memory.heatmap).map(o=>{return{n:e.memory.heatmap[o],x:o.charCodeAt(0)-32,y:o.charCodeAt(1)-32}}),r=_.filter(t,e=>e.n>0),n=_.sum(r,e=>e.n)/r.length*2;r.forEach(e=>{const t=e.n/n,r=getColourByPercentage(t>1?1:t);o.rect(e.x-.5,e.y-.5,1,1,{fill:r})})},e.creepPathStyle=function(e){function o(){let e="#";for(;e.length<7;)e+=Math.random().toString(16).substr(-6).substr(-1);return e}return e.data.pathColour=e.data.pathColour?e.data.pathColour:o(),{width:.15,color:e.data.pathColour,lineStyle:"dashed"}},e.drawCreepPath=function(o){const t=new RoomVisual(o.name);o.creeps.forEach(o=>{if(o.action!==Creep.action.idle&&!_.chain(o.pos).pick(["x","y"]).eq(o.data.determinatedSpot).value()&&o.memory&&o.memory._travel&&o.memory._travel.path){const r=o.memory._travel.path.substr(1),n=e.creepPathStyle(o);let a=o.pos.x,i=o.pos.y;if(0===o.fatigue){const e=+o.memory._travel.path[0];e===TOP?--i:e===TOP_RIGHT?(++a,--i):e===RIGHT?++a:e===BOTTOM_RIGHT?(++a,++i):e===BOTTOM?++i:e===BOTTOM_LEFT?(--a,++i):e===LEFT?--a:e===TOP_LEFT&&(--a,--i)}for(let s of r)s=+s,s===TOP?t.line(a,i,a,--i,n):s===TOP_RIGHT?t.line(a,i,++a,--i,n):s===RIGHT?t.line(a,i,++a,i,n):s===BOTTOM_RIGHT?t.line(a,i,++a,++i,n):s===BOTTOM?t.line(a,i,a,++i,n):s===BOTTOM_LEFT?t.line(a,i,--a,++i,n):s===LEFT?t.line(a,i,--a,i,n):s===TOP_LEFT&&t.line(a,i,--a,--i,n)}})},e.drawLine=function(o,t,r){if(o instanceof RoomObject&&(o=o.pos),t instanceof RoomObject&&(t=t.pos),!(o instanceof RoomPosition||t instanceof RoomPosition))throw new Error("Visuals: Point not a Room Position");if(o.roomName===t.roomName){const n=new RoomVisual(o.roomName);r=r instanceof Creep?e.creepPathStyle(r):r||{},n.line(o,t,r)}}},e.run=function(){for(let o in Game.rooms){const t=Game.rooms[o];if((ROOM_VISUALS_ALL||t.my)&&t.controller)if(void 0===Memory.heatmap&&(Memory.heatmap=!1),VISUALS.HEATMAP&&(Game.time%VISUALS.HEATMAP_INTERVAL===0&&e.setHeatMapData(t),Memory.heatmap))e.drawHeatMapData(t);else{if(VISUALS.ROOM&&e.drawRoomInfo(t,VISUALS.ROOM_GLOBAL),VISUALS.ROOM_ORDERS&&e.drawRoomOrders(t),VISUALS.ROOM_OFFERS&&e.drawRoomOffers(t),VISUALS.CONTROLLER&&e.drawControllerInfo(t.controller),VISUALS.SPAWN&&t.structures.spawns.filter(e=>e.spawning).forEach(e.drawSpawnInfo),VISUALS.MINERAL){let[o]=t.minerals;o&&e.drawMineralInfo(o)}VISUALS.SOURCE&&t.sources.forEach(e.drawSourceInfo),VISUALS.WALL&&e.highlightWeakest(t,STRUCTURE_WALL),VISUALS.RAMPART&&e.highlightWeakest(t,STRUCTURE_RAMPART),VISUALS.ROAD&&e.highlightWeakest(t,STRUCTURE_ROAD),VISUALS.STORAGE&&e.storage(t),VISUALS.TERMINAL&&e.terminal(t),VISUALS.TOWER&&t.structures.towers.forEach(e.drawTowerInfo),VISUALS.TRANSACTIONS&&e.drawTransactions(t),VISUALS.LABS&&e.drawLabs(t),VISUALS.CREEP&&e.drawCreepPath(t)}}VISUALS.ROOM_GLOBAL&&(VISUALS.CPU&&e.collectSparklineStats(),e.drawGlobal())};
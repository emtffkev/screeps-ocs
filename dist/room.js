// save original API functions
let e=Room.prototype.find,t={};module.exports=t,t.register=function(){Room.costMatrixInvalid.on(e=>Room.rebuildCostMatrix(e.name||e)),Flag.found.on(e=>Room.roomLayout(e))},t.pathfinderCache={},t.pathfinderCacheDirty=!1,t.pathfinderCacheLoaded=!1,t.COSTMATRIX_CACHE_VERSION=3,t.extend=function(){let r=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._container)){this._container=[];let e=e=>{let t=Game.getObjectById(e.id);t&&(_.assign(t,e),this._container.push(t))};_.forEach(this.room.memory.container,e)}return this._container}},controller:{configurable:!0,get:function(){if(_.isUndefined(this._controller))if(this.room.my&&this.room.controller.memory.storage)this._controller=[Game.getObjectById(this.room.controller.memory.storage)],this._controller[0]||delete this.room.controller.memory.storage;else{let e=e=>1==e.controller;this._controller=_.filter(this.all,e)}return this._controller}},in:{configurable:!0,get:function(){if(_.isUndefined(this._in)){let e=e=>0==e.controller;this._in=_.filter(this.all,e);let t=e=>e.sum>=e.storeCapacity*(1-MANAGED_CONTAINER_TRIGGER);this._in=this._in.concat(this.managed.filter(t))}return this._in}},out:{configurable:!0,get:function(){if(_.isUndefined(this._out)){let e=e=>1==e.controller;this._out=_.filter(this.all,e);let t=e=>e.sum<=e.storeCapacity*MANAGED_CONTAINER_TRIGGER;this._out=this._out.concat(this.managed.filter(t))}return this._out}},privateers:{configurable:!0,get:function(){if(_.isUndefined(this._privateers)){let e=e=>e.source===!1&&!e.mineral&&e.sum<e.storeCapacity;this._privateers=_.filter(this.all,e)}return this._privateers}},managed:{configurable:!0,get:function(){if(_.isUndefined(this._managed)){let e=e=>e.source===!0&&1==e.controller;this._managed=_.filter(this.all,e)}return this._managed}}})},o=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let e=e=>{let t=Game.getObjectById(e.id);t&&(_.assign(t,e),this._all.push(t))};_.forEach(this.room.memory.links,e)}return this._all}},controller:{configurable:!0,get:function(){if(_.isUndefined(this._controller)){let e=e=>e.controller===!0;this._controller=this.all.filter(e)}return this._controller}},storage:{configurable:!0,get:function(){if(_.isUndefined(this._storage)){let e=e=>1==e.storage;this._storage=this.all.filter(e)}return this._storage}},in:{configurable:!0,get:function(){if(_.isUndefined(this._in)){let e=e=>0==e.storage&&0==e.controller;this._in=_.filter(this.all,e)}return this._in}},privateers:{configurable:!0,get:function(){if(_.isUndefined(this._privateers)){let e=e=>0==e.storage&&0==e.controller&&0==e.source&&e.energy<.85*e.energyCapacity;this._privateers=_.filter(this.all,e)}return this._privateers}}})},i=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let e=e=>{let t=Game.getObjectById(e.id);t&&(_.assign(t,e),this._all.push(t))};_.forEach(this.room.memory.labs,e)}return this._all}},storage:{configurable:!0,get:function(){if(_.isUndefined(this._storage)){let e=e=>1==e.storage;this._storage=this.all.filter(e)}return this._storage}}})},n=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let e=e=>{let t=Game.getObjectById(e.id);t&&(_.assign(t,e),this._all.push(t))};_.forEach(this.room.memory.powerSpawns,e)}return this._all}}})},s=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){if(_.isUndefined(this._all)){this._all=[];let e=e=>{let t=Game.getObjectById(e.id);t&&(_.assign(t,e),this._all.push(t))};_.forEach(this.room.memory.nukers,e)}return this._all}}})},a=function(e){this.room=e,Object.defineProperties(this,{all:{configurable:!0,get:function(){return _.isUndefined(this._all)&&(this._all=this.room.find(FIND_STRUCTURES)),this._all}},my:{configurable:!0,get:function(){return _.isUndefined(this._my)&&(this._my=this.room.find(FIND_MY_STRUCTURES)),this._my}},spawns:{configurable:!0,get:function(){if(_.isUndefined(this._spawns)){this._spawns=[];var e=e=>{addById(this._spawns,e)};_.forEach(this.room.memory.spawns,e)}return this._spawns}},towers:{configurable:!0,get:function(){if(_.isUndefined(this._towers)){this._towers=[];var e=e=>{addById(this._towers,e)};_.forEach(this.room.memory.towers,e)}return this._towers}},repairable:{configurable:!0,get:function(){if(_.isUndefined(this._repairable)){let e=this;this._repairable=_.sortBy(e.all.filter(t=>t.hits<t.hitsMax&&(!e.room.my||t.hits<MAX_REPAIR_LIMIT[e.room.controller.level]||t.hits<LIMIT_URGENT_REPAIRING+(2*DECAY_AMOUNT[t.structureType]||0))&&(!DECAYABLES.includes(t.structureType)||t.hitsMax-t.hits>GAP_REPAIR_DECAYABLE)&&(void 0===Memory.pavementArt[e.room.name]||Memory.pavementArt[e.room.name].indexOf("x"+t.pos.x+"y"+t.pos.y+"x")<0)&&!FlagDir.list.some(e=>e.roomName==t.pos.roomName&&e.color==COLOR_ORANGE&&e.x==t.pos.x&&e.y==t.pos.y)),"hits")}return this._repairable}},urgentRepairable:{configurable:!0,get:function(){if(_.isUndefined(this._urgentRepairableSites)){var e=e=>e.hits<LIMIT_URGENT_REPAIRING+(DECAY_AMOUNT[e.structureType]||0);this._urgentRepairableSites=_.filter(this.repairable,e)}return this._urgentRepairableSites}},fortifyable:{configurable:!0,get:function(){if(_.isUndefined(this._fortifyableSites)){let e=this;this._fortifyableSites=_.sortBy(e.all.filter(t=>e.room.my&&t.hits<t.hitsMax&&t.hits<MAX_FORTIFY_LIMIT[e.room.controller.level]&&(t.structureType!=STRUCTURE_CONTAINER||t.hits<MAX_FORTIFY_CONTAINER)&&(!DECAYABLES.includes(t.structureType)||t.hitsMax-t.hits>3*GAP_REPAIR_DECAYABLE)&&(void 0===Memory.pavementArt[e.room.name]||Memory.pavementArt[e.room.name].indexOf("x"+t.pos.x+"y"+t.pos.y+"x")<0)&&!FlagDir.list.some(e=>e.roomName==t.pos.roomName&&e.color==COLOR_ORANGE&&e.x==t.pos.x&&e.y==t.pos.y)),"hits")}return this._fortifyableSites}},fuelable:{configurable:!0,get:function(){if(_.isUndefined(this._fuelables)){var e=this,t=e.room.situation.invasion?1:.82,r=e=>e.energy<e.energyCapacity*t;this._fuelables=_.sortBy(_.filter(this.towers,r),"energy")}return this._fuelables}},container:{configurable:!0,get:function(){return _.isUndefined(this._container)&&(this._container=new r(this.room)),this._container}},links:{configurable:!0,get:function(){return _.isUndefined(this._links)&&(this._links=new o(this.room)),this._links}},labs:{configurable:!0,get:function(){return _.isUndefined(this._labs)&&(this._labs=new i(this.room)),this._labs}},virtual:{configurable:!0,get:function(){return _.isUndefined(this._virtual)&&(this._virtual=_(this.all).concat(this.piles)),this._virtual}},piles:{configurable:!0,get:function(){if(_.isUndefined(this._piles)){const e=this.room;this._piles=FlagDir.filter(FLAG_COLOR.command.drop,e.getPositionAt(25,25),!0).map(function(t){const r=Game.flags[t.name],o=e.lookForAt(LOOK_ENERGY,r.pos.x,r.pos.y);return o.length&&o[0]||r})}return this._piles}},observer:{configurable:!0,get:function(){return _.isUndefined(this._observer)&&this.room.memory.observer&&(this._observer=Game.getObjectById(this.room.memory.observer.id)),this._observer}},nuker:{configurable:!0,get:function(){return _.isUndefined(this._nuker)&&this.room.memory.nukers&&this.room.memory.nukers.length>0&&(this._nuker=Game.getObjectById(this.room.memory.nukers[0].id)),this._nuker}},nukers:{configurable:!0,get:function(){return _.isUndefined(this._nukers)&&(this._nukers=new s(this.room)),this._nukers}},powerSpawn:{configurable:!0,get:function(){return _.isUndefined(this._powerSpawn)&&this.room.memory.powerSpawns&&this.room.memory.powerSpawns.length>0&&(this._powerSpawn=Game.getObjectById(this.room.memory.powerSpawns[0].id)),this._powerSpawn}},powerSpawns:{configurable:!0,get:function(){return _.isUndefined(this._powerSpawns)&&(this._powerSpawns=new n(this.room)),this._powerSpawns}},extensions:{configurable:!0,get:function(){return _.isUndefined(this.room.memory.extensions)&&this.room.saveExtensions(),_.isUndefined(this._extensions)&&(this._extensions=_.map(this.room.memory.extensions,e=>Game.getObjectById(e))),this._extensions}}})};Object.defineProperties(Room.prototype,{structures:{configurable:!0,get:function(){return _.isUndefined(this._structures)&&(this._structures=new a(this)),this._structures}},sources:{configurable:!0,get:function(){if((_.isUndefined(this.memory.sources)||"sim"==this.name)&&(this._sources=this.find(FIND_SOURCES),this._sources.length>0?this.memory.sources=this._sources.map(e=>e.id):this.memory.sources=[]),_.isUndefined(this._sources)){this._sources=[];var e=e=>{addById(this._sources,e)};this.memory.sources.forEach(e)}return this._sources}},powerBank:{configurable:!0,get:function(){return _.isUndefined(this.memory.powerBank)&&([this._powerBank]=this.find(FIND_STRUCTURES,{filter:e=>e instanceof StructurePowerBank}),this._powerBank&&(this.memory.powerBank=this._powerBank.id)),_.isUndefined(this._powerBank)&&(this._powerBank=Game.getObjectById(this.memory.powerBank)),this._powerBank}},droppedResources:{configurable:!0,get:function(){return _.isUndefined(this._droppedResources)&&(this._droppedResources=this.find(FIND_DROPPED_RESOURCES)),this._droppedResources}},sourceAccessibleFields:{configurable:!0,get:function(){if(_.isUndefined(this.memory.sourceAccessibleFields)){let t=0,r=this.sources;var e=e=>t+=e.accessibleFields;_.forEach(r,e),this.memory.sourceAccessibleFields=t}return this.memory.sourceAccessibleFields}},sourceEnergyAvailable:{configurable:!0,get:function(){if(_.isUndefined(this._sourceEnergyAvailable)){this._sourceEnergyAvailable=0;var e=e=>this._sourceEnergyAvailable+=e.energy;_.forEach(this.sources,e)}return this._sourceEnergyAvailable}},ticksToNextRegeneration:{configurable:!0,get:function(){return _.isUndefined(this._ticksToNextRegeneration)&&(this._ticksToNextRegeneration=_(this.sources).map("ticksToRegeneration").min()||0),this._ticksToNextRegeneration}},relativeEnergyAvailable:{configurable:!0,get:function(){return _.isUndefined(this._relativeEnergyAvailable)&&(this._relativeEnergyAvailable=this.energyCapacityAvailable>0?this.energyAvailable/this.energyCapacityAvailable:0),this._relativeEnergyAvailable}},reservedSpawnEnergy:{configurable:!0,get:function(){return _.isUndefined(this._reservedSpawnEnergy)&&(this._reservedSpawnEnergy=0),this._reservedSpawnEnergy},set:function(e){this._reservedSpawnEnergy=e}},remainingEnergyAvailable:{configurable:!0,get:function(){return this.energyAvailable-this.reservedSpawnEnergy}},relativeRemainingEnergyAvailable:{configurable:!0,get:function(){return this.energyCapacityAvailable>0?this.remainingEnergyAvailable/this.energyCapacityAvailable:0}},towerFreeCapacity:{configurable:!0,get:function(){if(_.isUndefined(this._towerFreeCapacity)){this._towerFreeCapacity=0;var e=e=>this._towerFreeCapacity+=e.energyCapacity-e.energy;_.forEach(this.structures.towers,e)}return this._towerFreeCapacity}},constructionSites:{configurable:!0,get:function(){return _.isUndefined(this._constructionSites)&&(this._constructionSites=this.find(FIND_CONSTRUCTION_SITES)),this._constructionSites}},myConstructionSites:{configurable:!0,get:function(){return _.isUndefined(this._myConstructionSites)&&(this._myConstructionSites=this.find(FIND_MY_CONSTRUCTION_SITES)),this._myConstructionSites}},creeps:{configurable:!0,get:function(){return _.isUndefined(this._creeps)&&(this._creeps=this.find(FIND_MY_CREEPS)),this._creeps}},allCreeps:{configurable:!0,get:function(){return _.isUndefined(this._allCreeps)&&(this._allCreeps=this.find(FIND_CREEPS)),this._allCreeps}},immobileCreeps:{configurable:!0,get:function(){return _.isUndefined(this._immobileCreeps)&&(this._immobileCreeps=_.filter(this.creeps,e=>{const t=e.data&&e.data.determinatedSpot;return t&&e.pos.isEqualTo(e.room.getPositionAt(t.x,t.y))})),this._immobileCreeps}},hostiles:{configurable:!0,get:function(){return _.isUndefined(this._hostiles)&&(this._hostiles=this.find(FIND_HOSTILE_CREEPS,{filter:Task.reputation.hostileOwner})),this._hostiles}},hostileIds:{configurable:!0,get:function(){return _.isUndefined(this._hostileIds)&&(this._hostileIds=_.map(this.hostiles,"id")),this._hostileIds}},combatCreeps:{configurable:!0,get:function(){return _.isUndefined(this._combatCreeps)&&(this._combatCreeps=this.creeps.filter(e=>["melee","ranger","healer","warrior"].includes(e.data.creepType))),this._combatCreeps}},casualties:{configurable:!0,get:function(){if(_.isUndefined(this._casualties)){var e=e=>e.hits<e.hitsMax&&(void 0===e.towers||0==e.towers.length);this._casualties=_.sortBy(_.filter(this.creeps,e),"hits")}return this._casualties}},situation:{configurable:!0,get:function(){return _.isUndefined(this._situation)&&(this._situation={noEnergy:0==this.sourceEnergyAvailable,invasion:this.hostiles.length>0&&(!this.controller||!this.controller.safeMode)}),this._situation}},roadConstructionTrace:{configurable:!0,get:function(){return _.isUndefined(this.memory.roadConstructionTrace)&&(this.memory.roadConstructionTrace={}),this.memory.roadConstructionTrace}},adjacentRooms:{configurable:!0,get:function(){return _.isUndefined(this.memory.adjacentRooms)&&(this.memory.adjacentRooms=Room.adjacentRooms(this.name)),this.memory.adjacentRooms}},adjacentAccessibleRooms:{configurable:!0,get:function(){return _.isUndefined(this.memory.adjacentAccessibleRooms)&&(this.memory.adjacentAccessibleRooms=Room.adjacentAccessibleRooms(this.name)),this.memory.adjacentAccessibleRooms}},privateerMaxWeight:{configurable:!0,get:function(){if(_.isUndefined(this._privateerMaxWeight)&&(this._privateerMaxWeight=0,!this.situation.invasion&&!this.conserveForDefense)){let e,t,r,o,i=1e3*this.controller.level,n=this,s=FlagDir.filter([FLAG_COLOR.invade.robbing,FLAG_COLOR.invade.exploit]),a=e=>{e!=n.name&&Room.isMine(e)&&t++},c=s=>{this.adjacentAccessibleRooms.includes(s.roomName)&&(r=Game.rooms[s.roomName],r?(e=r.adjacentAccessibleRooms,o=r.sources.length):(e=Room.adjacentAccessibleRooms(s.roomName),o=1),t=1,e.forEach(a),n._privateerMaxWeight+=o*i/t)};s.forEach(c)}return this._privateerMaxWeight}},claimerMaxWeight:{configurable:!0,get:function(){if(_.isUndefined(this._claimerMaxWeight)){this._claimerMaxWeight=0;let e,t,r,o=1250,i=2,n=this,s=this.controller.level,a=FlagDir.filter([FLAG_COLOR.claim,FLAG_COLOR.claim.reserve,FLAG_COLOR.invade.exploit]),c=a=>{if(s>3||a.color==FLAG_COLOR.claim.color&&a.secondaryColor==FLAG_COLOR.claim.secondaryColor){if(e=Room.roomDistance(n.name,a.roomName),e>i)return;if(r=Game.flags[a.name],r.room&&r.room.controller&&r.room.controller.reservation&&r.room.controller.reservation.ticksToEnd>2500)return;t=r.targetOf&&r.targetOf?_.sum(r.targetOf.map(e=>"claimer"==e.creepType?e.weight:0)):0,n._claimerMaxWeight+=o-t}};a.forEach(c)}return this._claimerMaxWeight}},conserveForDefense:{configurable:!0,get:function(){return this.my&&this.storage&&this.storage.charge<0}},hostileThreatLevel:{configurable:!0,get:function(){if(_.isUndefined(this._hostileThreatLevel)){this._hostileThreatLevel=0;let e=e=>{this._hostileThreatLevel+=e.threat};this.hostiles.forEach(e)}return this._hostileThreatLevel}},defenseLevel:{configurable:!0,get:function(){if(_.isUndefined(this._defenseLevel)){this._defenseLevel={towers:0,creeps:0,sum:0};let e=e=>{this._defenseLevel.creeps+=e.threat};this.combatCreeps.forEach(e),this._defenseLevel.towers=this.structures.towers.length,this._defenseLevel.sum=this._defenseLevel.creeps+this._defenseLevel.towers*Creep.partThreat.tower}return this._defenseLevel}},minerals:{configurable:!0,get:function(){if(_.isUndefined(this._minerals)){this._minerals=[];let e=e=>{addById(this._minerals,e)};_.forEach(this.memory.minerals,e)}return this._minerals}},mineralType:{configurable:!0,get:function(){if(_.isUndefined(this.memory.mineralType)){let e=this.find(FIND_MINERALS);e&&e.length>0?this.memory.mineralType=e[0].mineralType:this.memory.mineralType=""}return this.memory.mineralType}},structureMatrix:{configurable:!0,get:function(){if(_.isUndefined(this._structureMatrix)){const r=e=>{if(_.isUndefined(t.pathfinderCache))return t.pathfinderCache={},t.pathfinderCache[e]={},!1;if(_.isUndefined(t.pathfinderCache[e]))return t.pathfinderCache[e]={},!1;const r=t.pathfinderCache[e],o=Game.time-r.updated;return!!(r.version===t.COSTMATRIX_CACHE_VERSION&&(r.serializedMatrix||r.costMatrix)&&o<COST_MATRIX_VALIDITY)&&(DEBUG&&TRACE&&trace("PathFinder",{roomName:this.name,ttl:o,PathFinder:"CostMatrix"},"cached costmatrix"),!0)};if(r(this.name)){if(_.isUndefined(t.pathfinderCache[this.name].costMatrix)){const e=PathFinder.CostMatrix.deserialize(t.pathfinderCache[this.name].serializedMatrix);t.pathfinderCache[this.name].costMatrix=e}this._structureMatrix=t.pathfinderCache[this.name].costMatrix}else{DEBUG&&logSystem(this.name,"Calculating cost matrix");var e=new PathFinder.CostMatrix;let r=t=>{const r=t instanceof ConstructionSite;if(r&&!t.my&&Task.reputation.allyOwner(t))return e.set(t.pos.x,t.pos.y,255);if(t.structureType===STRUCTURE_ROAD){if(!r||USE_UNBUILT_ROADS)return e.set(t.pos.x,t.pos.y,1)}else{if(t.structureType===STRUCTURE_PORTAL)return e.set(t.pos.x,t.pos.y,255);if(OBSTACLE_OBJECT_TYPES.includes(t.structureType)){if(!r||Task.reputation.allyOwner(t))return e.set(t.pos.x,t.pos.y,255)}else if(t.structureType===STRUCTURE_RAMPART&&!t.my&&!t.isPublic&&(!r||Task.reputation.allyOwner(t)))return e.set(t.pos.x,t.pos.y,255)}};this.structures.all.forEach(r),this.constructionSites.forEach(r),this.immobileCreeps.forEach(t=>e.set(t.pos.x,t.pos.y,255));const o=t.pathfinderCache[this.name].updated;t.pathfinderCache[this.name]={costMatrix:e,updated:Game.time,version:t.COSTMATRIX_CACHE_VERSION},t.pathfinderCacheDirty=!0,DEBUG&&TRACE&&trace("PathFinder",{roomName:this.name,prevTime:o,structures:this.structures.all.length,PathFinder:"CostMatrix"},"updated costmatrix"),this._structureMatrix=e}}return this._structureMatrix}},creepMatrix:{configurable:!0,get:function(){if(_.isUndefined(this._creepMatrix)){const e=this.structureMatrix.clone();this.allCreeps.forEach(function(t){e.set(t.pos.x,t.pos.y,255)}),this._creepMatrix=e}return this._creepMatrix}},my:{configurable:!0,get:function(){return _.isUndefined(this._my)&&(this._my=this.controller&&this.controller.my),this._my}},reserved:{configurable:!0,get:function(){if(_.isUndefined(this._reserved))if(this.controller){const e=_.find(Game.spawns).owner.username;this._reserved=this.controller.my||this.controller.reservation&&this.controller.reservation.username===e}else this._reserved=!1;return this._reserved}},owner:{configurable:!0,get:function(){return _.isUndefined(this._owner)&&(this.controller&&this.controller.owner?this._owner=this.controller.owner.username:this._owner=!1),this._owner}},reservation:{configurable:!0,get:function(){return _.isUndefined(this._reservation)&&(this.controller&&this.controller.reservation?this._reservation=this.controller.reservation.username:this._reservation=!1),this._reservation}},ally:{configurable:!0,get:function(){return _.isUndefined(this._ally)&&(this.reserved?this._ally=!0:this.controller?this._ally=Task.reputation.isAlly(this.owner)||Task.reputation.isAlly(this.reservation):this._ally=!1),this._ally}},spawnQueueHigh:{configurable:!0,get:function(){return _.isUndefined(this.memory.spawnQueueHigh)&&(this.memory.spawnQueueHigh=[]),this.memory.spawnQueueHigh}},spawnQueueMedium:{configurable:!0,get:function(){return _.isUndefined(this.memory.spawnQueueMedium)&&(this.memory.spawnQueueMedium=[]),this.memory.spawnQueueMedium}},spawnQueueLow:{configurable:!0,get:function(){return _.isUndefined(this.memory.spawnQueueLow)&&(this.memory.spawnQueueLow=[]),this.memory.spawnQueueLow}},pavementArt:{configurable:!0,get:function(){return _.isUndefined(this.memory.pavementArt)&&(this.memory.pavementArt=[]),this.memory.pavementArt}},collapsed:{configurable:!0,get:function(){if(_.isUndefined(this._collapsed)){if(!this.my)return void(this._collapsed=!1);if(!this.population)return void(this._collapsed=!0);let e=this.population.typeCount.worker?this.population.typeCount.worker:0,t=this.population.typeCount.hauler?this.population.typeCount.hauler:0,r=this.population.typeCount.pioneer?this.population.typeCount.pioneer:0;this._collapsed=e+t+r===0}return this._collapsed}},hostile:{configurable:!0,get:function(){return this.memory.hostile}}}),Room.prototype.countMySites=function(){const e=_.size(this.myConstructionSites);_.isUndefined(this.memory.myTotalSites)||e===this.memory.myTotalSites||Room.costMatrixInvalid.trigger(this),e>0?this.memory.myTotalSites=e:delete this.memory.myTotalSites},Room.prototype.countMyStructures=function(){const e=_.size(this.structures.my);!_.isUndefined(this.memory.myTotalStructures)&&e<this.memory.myTotalStructures&&Room.costMatrixInvalid.trigger(this),e>0?this.memory.myTotalStructures=e:delete this.memory.myTotalStructures},Room.prototype.registerIsHostile=function(){this.controller&&(_.isUndefined(this.hostile)||"number"==typeof this.hostile)&&(!this.controller.owner||this.controller.my||this.ally?delete this.memory.hostile:this.memory.hostile=this.controller.level)},Room.prototype.getBorder=function(e){return _.findKey(Game.map.describeExits(this.name),function(e){return this.name===e},{name:e})},Room.prototype.find=function(t,r){return _.isArray(t)?_(t).map(t=>e.call(this,t,r)).flatten().value():e.apply(this,arguments)},Room.prototype.findRoute=function(e,t=true,r=true){if(this.name==e)return[];const o={checkOwner:t,preferHighway:r};return Game.map.findRoute(this,e,{routeCallback:Room.routeCallback(this.name,e,o)})},Room.prototype.getBestConstructionSiteFor=function(e,t=null){let r;if(r=t?this.constructionSites.filter(t):this.constructionSites,0==r.length)return null;let o=Util.fieldOrFunction(CONSTRUCTION_PRIORITY,this),i=t=>{let r=o.indexOf(t.structureType);return e.getRangeTo(t)+(r<0?1e5:100*r)};return _.min(r,i)},Room.prototype.roadConstruction=function(e=ROAD_CONSTRUCTION_MIN_DEVIATION){if(ROAD_CONSTRUCTION_ENABLE&&Game.time%ROAD_CONSTRUCTION_INTERVAL==0&&(!_.isNumber(ROAD_CONSTRUCTION_ENABLE)||this.my&&!(ROAD_CONSTRUCTION_ENABLE>this.controller.level))){let t=Object.keys(this.roadConstructionTrace).map(e=>{return{n:this.roadConstructionTrace[e],x:e.charCodeAt(0)-32,y:e.charCodeAt(1)-32}}),r=Math.max(ROAD_CONSTRUCTION_ABS_MIN,t.reduce((e,t)=>e+t.n,0)/t.length*e);t=t.filter(e=>{if(e.n>=r){let t=this.lookForAt(LOOK_STRUCTURES,e.x,e.y);return(0===t.length||t[0].structureType===STRUCTURE_RAMPART)&&0===this.lookForAt(LOOK_CONSTRUCTION_SITES,e.x,e.y).length}return!1});let o=e=>{DEBUG&&logSystem(this.name,`Constructing new road at ${e.x}'${e.y} (${e.n} traces)`),this.createConstructionSite(e.x,e.y,STRUCTURE_ROAD)};_.forEach(t,o),this.roadConstructionTrace={}}},Room.prototype.recordMove=function(e){if(ROAD_CONSTRUCTION_ENABLE){let t=e.pos.x,r=e.pos.y;if(0!=t&&0!=r&&49!=t&&49!=r&&0!=e.carry.energy&&"building"!=e.data.actionName){let e=`${String.fromCharCode(32+t)}${String.fromCharCode(32+r)}_x${t}-y${r}`;this.roadConstructionTrace[e]?this.roadConstructionTrace[e]++:this.roadConstructionTrace[e]=1}}},Room.prototype.saveTowers=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:{structureType:STRUCTURE_TOWER}});if(e.length>0){var t=e=>e.id;this.memory.towers=_.map(e,t)}else delete this.memory.towers},Room.prototype.saveSpawns=function(){let e=this.find(FIND_MY_SPAWNS);if(e.length>0){let t=e=>e.id;this.memory.spawns=_.map(e,t)}else delete this.memory.spawns},Room.prototype.saveObserver=function(){this.memory.observer={},[this.memory.observer.id]=this.find(FIND_MY_STRUCTURES,{filter:e=>e instanceof StructureObserver}).map(e=>e.id),_.isUndefined(this.memory.observer.id)&&delete this.memory.observer},Room.prototype.saveNukers=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType==STRUCTURE_NUKER});if(e.length>0){this.memory.nukers=[];let t=e=>{let t=this.memory.nukers.find(t=>t.id==e.id);t||this.memory.nukers.push({id:e.id})};e.forEach(t)}else delete this.memory.nukers},Room.prototype.savePowerSpawns=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType==STRUCTURE_POWER_SPAWN});if(e.length>0){this.memory.powerSpawns=[];let t=e=>{let t=this.memory.powerSpawns.find(t=>t.id==e.id);t||this.memory.powerSpawns.push({id:e.id})};e.forEach(t)}else delete this.memory.powerSpawns},Room.prototype.saveExtensions=function(){const e=this.find(FIND_MY_STRUCTURES,{filter:e=>e instanceof StructureExtension}).map(e=>e.id);e.length>0?this.memory.extensions=e:delete this.memory.extensions},Room.prototype.saveContainers=function(){let e=this.structures.all.filter(e=>e.structureType==STRUCTURE_CONTAINER);if(e.length>0){this.memory.container=[];let t=e=>{let t=this.find(FIND_MINERALS),r=e.pos.findInRange(this.sources,2),o=e.pos.findInRange(t,2),i=!!(this.my&&e.pos.getRangeTo(this.controller)<=4);this.memory.container.push({id:e.id,source:r.length>0,controller:i,mineral:o.length>0});let n=t=>t.memory.container=e.id;r.forEach(n),o.forEach(n)};e.forEach(t)}else delete this.memory.container;if(this.terminal){let e=[],t=t=>{e=_(e).concat(Room.validFields(this.name,t.pos.x-1,t.pos.x+1,t.pos.y-1,t.pos.y+1,!0))};_.forEach(this.sources,t);let r=this.terminal.pos.findClosestByRange(e,1),o=[];r&&(1==this.sources.length?o=this.sources:o.push(r.isNearTo(this.sources[0])?this.sources[0]:this.sources[1]));let i=this.terminal.pos.findInRange(this.minerals,2),n=e=>e.memory.terminal=this.terminal.id;o.forEach(n),i.forEach(n)}if(this.storage){let e=this.storage.pos.findInRange(this.sources,2),t=this.storage.pos.findInRange(this.minerals,2),r=e=>e.memory.storage=this.storage.id;e.forEach(r),t.forEach(r),this.storage.pos.getRangeTo(this.controller)<4&&(this.controller.memory.storage=this.storage.id)}},Room.prototype.saveLinks=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType==STRUCTURE_LINK});if(e.length>0){this.memory.links=[];let t=this.storage?this.storage.pos.findInRange(e,2).map(e=>e.id):[];/*
            let kept = [];
            let keep = (entry) => {
                if( links.find( (c) => c.id == entry.id )){
                    entry.storage = storageLinks.includes(entry.id);
                    kept.push(entry);
                }
            };
            this.memory.links.forEach(keep);
            this.memory.links = kept;
            */
this.memory.links=[];let r=e=>{if(!this.memory.links.find(t=>t.id==e.id)){let r=e.pos.getRangeTo(this.controller)<=4,o=!1;if(!r){let t=e.pos.findInRange(this.sources,2),r=t=>t.memory.link=e.id;t.forEach(r),o=t.length>0}this.memory.links.push({id:e.id,storage:t.includes(e.id),controller:r,source:o})}};e.forEach(r)}else delete this.memory.links},Room.prototype.saveLabs=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType==STRUCTURE_LAB});if(e.length>0){this.memory.labs=[];let t=this.storage?this.storage.pos.findInRange(e,2).map(e=>e.id):[];this.memory.labs=[];let r=e=>{let r=this.memory.labs.find(t=>t.id==e.id);r||this.memory.labs.push({id:e.id,storage:t.includes(e.id)})};e.forEach(r)}else delete this.memory.labs},Room.prototype.saveMinerals=function(){let e=e=>{return{x:e.pos.x,y:e.pos.y}},t=this.structures.all.filter(e=>e.structureType==STRUCTURE_EXTRACTOR).map(e),r=e=>_.some(t,{x:e.pos.x,y:e.pos.y});const o=this.find(FIND_MINERALS).filter(r);if(o.length>0){let e=e=>e.id;this.memory.minerals=_.map(o,e)}else delete this.memory.minerals},Room.prototype.linkDispatcher=function(){let e=e=>0==e.cooldown&&e.energy>=e.energyCapacity*(e.source?.85:.5),t=e=>e.energy<.15*e.energyCapacity,r=this.structures.links.in.filter(e),o=this.structures.links.controller.filter(t);if(r.length>0){let e=this.structures.links.storage.filter(t),i=t=>{o.length>0?(t.transferEnergy(o[0]),o.shift()):e.length>0&&(t.transferEnergy(e[0]),e.shift())};r.forEach(i)}if(o.length>0){let t=this.structures.links.storage.filter(e),r=e=>{o.length>0&&(e.transferEnergy(o[0]),o.shift())};t.forEach(r)}},Room.prototype.processConstructionFlags=function(){if(this.my&&Util.fieldOrFunction(SEMI_AUTOMATIC_CONSTRUCTION,this)){let e=_.size(Game.constructionSites);if(!(e>=100)){const t=this.controller.level,r=new RoomPosition(25,25,this.name),o=[r,!0],i=(t,r)=>{if(!(e>=100)&&t){const o=new RoomPosition(t.x,t.y,t.roomName);if(o){const i=o.lookFor(LOOK_CONSTRUCTION_SITES);if(!i||!i.length){const i=o.lookFor(LOOK_STRUCTURES).filter(e=>!(e instanceof StructureRoad||e instanceof StructureRampart));if(!i||!i.length){const i=o.createConstructionSite(r);Util.fieldOrFunction(REMOVE_CONSTRUCTION_FLAG,this,r)&&i===OK&&(t.name&&(t=Game.flags[t.name],t instanceof Flag&&t.remove()),e++)}}}}};let n=CONTROLLER_STRUCTURES[STRUCTURE_EXTENSION][t]-(this.structures.extensions.length+_.filter(this.constructionSites,e=>e.structureType===STRUCTURE_EXTENSION).length);if(n>0&&FlagDir.filter(FLAG_COLOR.construct,...o).splice(0,n).forEach(e=>{i(e,STRUCTURE_EXTENSION)}),n=CONTROLLER_STRUCTURES[STRUCTURE_SPAWN][t]-(this.structures.spawns.length+_.filter(this.constructionSites,e=>e.structureType===STRUCTURE_SPAWN).length),n>0&&FlagDir.filter(FLAG_COLOR.construct.spawn,...o).splice(0,n).forEach(e=>{i(e,STRUCTURE_SPAWN)}),n=CONTROLLER_STRUCTURES[STRUCTURE_TOWER][t]-(this.structures.towers.length+_.filter(this.constructionSites,e=>e.structureType===STRUCTURE_TOWER).length),n>0&&FlagDir.filter(FLAG_COLOR.construct.tower,...o).splice(0,n).forEach(e=>{i(e,STRUCTURE_TOWER)}),n=CONTROLLER_STRUCTURES[STRUCTURE_LINK][t]-(this.structures.links.all.length+_.filter(this.constructionSites,e=>e.structureType===STRUCTURE_LINK).length),n>0&&FlagDir.filter(FLAG_COLOR.construct.link,...o).splice(0,n).forEach(e=>{i(e,STRUCTURE_LINK)}),n=CONTROLLER_STRUCTURES[STRUCTURE_LAB][t]-(this.structures.labs.all.length+_.filter(this.constructionSites,e=>e.structureType===STRUCTURE_LAB).length),n>0&&FlagDir.filter(FLAG_COLOR.construct.lab,...o).splice(0,n).forEach(e=>{i(e,STRUCTURE_LAB)}),!this.storage&&CONTROLLER_STRUCTURES[STRUCTURE_STORAGE][t]>0&&FlagDir.filter(FLAG_COLOR.construct.storage,...o).splice(0,1).forEach(e=>{i(e,STRUCTURE_STORAGE)}),!this.terminal&&CONTROLLER_STRUCTURES[STRUCTURE_TERMINAL][t]>0&&FlagDir.filter(FLAG_COLOR.construct.terminal,...o).splice(0,1).forEach(e=>{i(e,STRUCTURE_TERMINAL)}),!this.structures.observer&&CONTROLLER_STRUCTURES[STRUCTURE_OBSERVER][t]>0&&FlagDir.filter(FLAG_COLOR.construct.observer,...o).splice(0,1).forEach(e=>{i(e,STRUCTURE_OBSERVER)}),!this.structures.nuker&&CONTROLLER_STRUCTURES[STRUCTURE_NUKER][t]>0&&FlagDir.filter(FLAG_COLOR.construct.nuker,...o).splice(0,1).forEach(e=>{i(e,STRUCTURE_NUKER)}),!this.structures.powerSpawn&&CONTROLLER_STRUCTURES[STRUCTURE_POWER_SPAWN][t]>0&&FlagDir.filter(FLAG_COLOR.construct.powerSpawn,...o).splice(0,1).forEach(e=>{i(e,STRUCTURE_POWER_SPAWN)}),CONTROLLER_STRUCTURES[STRUCTURE_EXTRACTOR][t]>0){const[e]=this.find(FIND_MINERALS),t=e.pos.lookFor(LOOK_STRUCTURES);if(t.length&&t[0]instanceof StructureExtractor)return;i(e.pos,STRUCTURE_EXTRACTOR)}}}},Room.prototype.updateResourceOrders=function(){let e=this.memory.resources;if(this.my&&e){this.controller.level;for(let t in e)for(let r=0;r<e[t].length;r++){let o=e[t][r];if((t!=STRUCTURE_LAB||o.reactionState==LAB_IDLE)&&o.orders)for(let i=0;i<o.orders.length;i++){let e=o.orders[i];if(e.orderRemaining<=0){let r=0,i=this.controller.level;t==STRUCTURE_STORAGE?r=e.type==RESOURCE_ENERGY?MIN_STORAGE_ENERGY[i]:MAX_STORAGE_MINERAL:t==STRUCTURE_TERMINAL&&(r=e.type==RESOURCE_ENERGY?TERMINAL_ENERGY:0),r+=e.storeAmount;let n=0,s=Game.getObjectById(o.id);if(s)switch(t){case STRUCTURE_LAB:e.type==s.mineralType?n=s.mineralAmount:e.type==RESOURCE_ENERGY&&(n=s.energy);break;case STRUCTURE_POWER_SPAWN:e.type==RESOURCE_POWER?n=s.power:e.type==RESOURCE_ENERGY&&(n=s.energy);break;default:n=s.store[e.type]||0}n<=r&&(e.orderAmount=0,e.orderRemaining=0)}}}}},Room.prototype.updateRoomOrders=function(){if(this.memory.resources&&this.memory.resources.orders){let e=_.filter(Game.rooms,e=>{return e.my&&e.storage&&e.terminal&&e.name!==this.name}),t=this.memory.resources.orders;for(let r=0;r<t.length;r++){let o=t[r],i=o.amount;for(let n=0;n<o.offers.length;n++){let e=o.offers[n];if(Memory.rooms[e.room]&&Memory.rooms[e.room].resources&&Memory.rooms[e.room].resources.offers){let t=Memory.rooms[e.room].resources.offers,r=t.indexOf(e=>{return e.room==this.name&&e.id==o.id&&e.type==o.type});r!==-1&&t.splice(r,1)}}if(o.offers=[],i<=0)delete t[r],t.splice(r--,1);else{e.sort((e,t)=>{return Game.map.getRoomLinearDistance(this.name,e.name,!0)-Game.map.getRoomLinearDistance(this.name,t.name,!0)});for(let t=0;t<e.length;t++){let r=e[t];void 0===r.memory.resources&&(r.memory.resources={lab:[],container:[],terminal:[],storage:[],powerSpawn:[]});let n=(r.storage.store[o.type]||0)+(r.terminal.store[o.type]||0);if(!(n<100)){n=Math.min(n,i),r.memory.resources.offers||(r.memory.resources.offers=[]);let e=o.offers.find(e=>e.room==r.name),t=r.memory.resources.offers,s=t.find(e=>{return e.room==this.name&&e.id==o.id&&e.type==o.type});if(e?(DEBUG&&TRACE&&trace("Room",{roomName:this.name,remoteRoom:r.name,actionName:"updateRoomOrders",subAction:"update",orderId:o.id,resourceType:o.type,amount:n}),i-=n-e.amount,e.amount=n):(DEBUG&&TRACE&&trace("Room",{roomName:this.name,remoteRoom:r.name,actionName:"updateRoomOrders",subAction:"new",orderId:o.id,resourceType:o.type,amount:n}),DEBUG&&logSystem(this.name,`Room offer from ${r.name} with id ${o.id} placed for ${n} ${o.type}.`),i-=n,o.offers.push({room:r.name,amount:n})),s?s.amount=n:t.push({room:this.name,id:o.id,type:o.type,amount:n}),i<=0)break}}}}}},Room.prototype.fillARoomOrder=function(){if(!(this.terminal&&this.memory&&this.memory.resources&&this.memory.resources.offers))return!1;let e=this.memory.resources.offers;for(let t=0;t<e.length;t++){let r=e[t],o=Game.rooms[r.room];if(o&&o.memory&&o.memory.resources&&o.memory.resources.orders){let i=o.memory.resources.orders.find(e=>{return e.id==r.id&&e.type==r.type});if(i){let n=i.offers.findIndex(e=>{return e.room==this.name});if(n!=-1){let s=this.terminal.store[r.type]||0,a=0,c=null;this.memory.resources.terminal[0]&&(c=this.memory.resources.terminal[0].orders.find(e=>{return e.type==r.type})),c&&(a=c.orderRemaining);let m=Math.max(r.amount,100);if(m>s+a){let e=m-(s+a);DEBUG&&TRACE&&trace("Room",{actionName:"fillARoomOrder",subAction:"terminalOrder",roomName:this.name,targetRoomName:o.name,resourceType:r.type,amount:e}),this.placeOrder(this.terminal.id,r.type,e)}if(o.terminal){let a=o.terminal.storeCapacity-o.terminal.sum;m=Math.min(m,a,s);let c=Game.market.calcTransactionCost(m,this.name,o.name);if(r.type==RESOURCE_ENERGY&&(m-=c,c+=m),!(c>(this.terminal.store.energy||0)||m<100)){let s=this.terminal.send(r.type,m,o.name,i.id);if(s==OK)return DEBUG&&TRACE&&trace("Room",{actionName:"fillARoomOrder",roomName:this.name,targetRoomName:o.name,resourceType:r.type,amount:m}),DEBUG&&logSystem(this.name,`Room order filled to ${o.name} for ${m} ${r.type}.`),r.amount-=m,r.amount>0?i.offers[n].amount=r.amount:(delete i.offers[n],i.offers.splice(n,1),delete e[t],e.splice(t--,1)),i.amount-=m,!0}}}else logSystem(this.name,"Orphaned offer found and deleted"),e.splice(t--,1)}}}return!1},Room.prototype.terminalBroker=function(){if(this.my&&this.terminal&&this.storage){let e=this,t=this.mineralType,r=!1,o=this.terminal.sum/this.terminal.storeCapacity>.8;if(this.terminal.store[t]>=MIN_MINERAL_SELL_AMOUNT){let i=Game.market.getAllOrders(r=>{return!(!r.roomName||r.resourceType!=t||"buy"!=r.type||r.amount<MIN_MINERAL_SELL_AMOUNT)&&(r.range=Game.map.getRoomLinearDistance(r.roomName,e.name,!0),r.transactionAmount=Math.min(r.amount,e.terminal.store[t]),r.transactionCost=Game.market.calcTransactionCost(r.transactionAmount,e.name,r.roomName),r.transactionCost>e.terminal.store.energy&&r.transactionAmount>MIN_MINERAL_SELL_AMOUNT&&(r.transactionAmount=MIN_MINERAL_SELL_AMOUNT,r.transactionCost=Game.market.calcTransactionCost(r.transactionAmount,e.name,r.roomName)),r.credits=r.transactionAmount*r.price,r.ratio=(r.credits-r.transactionCost*ENERGY_VALUE_CREDITS)/r.transactionAmount,(o||r.ratio>=MIN_SELL_RATIO[t])&&r.transactionCost<=e.terminal.store.energy)});if(i.length>0){let o=_.max(i,"ratio"),n=Game.market.deal(o.id,o.transactionAmount,e.name);(DEBUG||SELL_NOTIFICATION)&&logSystem(e.name,`Selling ${o.transactionAmount} ${t} for ${o.credits} (${o.price} ¢/${t}, ${o.transactionCost} e): ${translateErrorCode(n)}`),SELL_NOTIFICATION&&Game.notify(`<h2>Room ${e.name} executed an order!</h2><br/>Result: ${translateErrorCode(n)}<br/>Details:<br/>${JSON.stringify(o).replace(",",",<br/>")}`),r=n==OK}}if(8==this.controller.level&&!r&&this.storage.charge>.8&&(this.terminal.store[t]||0)<15e4&&this.terminal.store.energy>55e3){let t=e=>e.my&&e.storage&&e.terminal&&e.terminal.sum<e.terminal.storeCapacity-5e4&&e.storage.sum<.6*e.storage.storeCapacity&&!e._isReceivingEnergy,o=_.min(_.filter(Game.rooms,t),"storage.store.energy");if(o instanceof Room&&Game.market.calcTransactionCost(5e4,this.name,o.name)<this.terminal.store.energy-5e4){o._isReceivingEnergy=!0;let t=this.terminal.send("energy",5e4,o.name,"have fun");DEBUG&&logSystem(e.name,`Transferring 50k energy to ${o.name}: ${translateErrorCode(t)}`),r=t==OK}}r||(r=this.fillARoomOrder())}},Room.prototype.processInvaders=function(){let e=this;void 0===this.memory.hostileIds&&(this.memory.hostileIds=[]),SEND_STATISTIC_REPORTS?void 0===this.memory.statistics&&(this.memory.statistics={}):delete this.memory.statistics;let t=t=>{if(!Room.isCenterNineRoom(this.name)&&!e.memory.hostileIds.includes(t.id)&&(e.memory.hostileIds.push(t.id),e.newInvader.push(t),SEND_STATISTIC_REPORTS)){let r=JSON.stringify(_.countBy(t.body,"type"));void 0===e.memory.statistics.invaders&&(e.memory.statistics.invaders=[]),e.memory.statistics.invaders.push({owner:t.owner.username,id:t.id,body:r,enter:Game.time,time:Date.now()})}};_.forEach(this.hostiles,t);let r=t=>{const r=Game.getObjectById(t),o=!r||Task.reputation.hostileOwner(r);if(!e.hostileIds.includes(t)&&!o&&(e.goneInvader.push(t),SEND_STATISTIC_REPORTS&&e.memory.statistics&&void 0!==e.memory.statistics.invaders&&e.memory.statistics.invaders.length>0)){let r=e=>e.id==t&&void 0===e.leave,o=_.find(e.memory.statistics.invaders,r);void 0!=o&&(o.leave=Game.time)}};_.forEach(this.memory.hostileIds,r),this.memory.hostileIds=this.hostileIds},Room.prototype.processReactorFlowerBurst=function(){let e=this.memory.resources.reactions;if(e&&e.reactorType===REACTOR_TYPE_FLOWER&&e.reactorMode===REACTOR_MODE_BURST){let t=e.orders[0];if(t.mode===REACTOR_MODE_BURST){let r=LAB_REACTIONS[t.type][0],o=LAB_REACTIONS[t.type][1],i=Game.getObjectById(e.seed_a),n=Game.getObjectById(e.seed_b);if(i&&n){let s=this.memory.resources.lab.find(t=>t.id===e.seed_a),a=this.memory.resources.lab.find(t=>t.id===e.seed_b);if(s&&s.reactionType===r||(this.placeOrder(e.seed_a,r,t.amount),s=this.memory.resources.lab.find(t=>t.id===e.seed_a),s.reactionType=r),a&&a.reactionType===o||(this.placeOrder(e.seed_b,o,t.amount),a=this.memory.resources.lab.find(t=>t.id===e.seed_b),a.reactionType=o),s&&a){let c=s.orders.find(e=>e.type===r),m=a.orders.find(e=>e.type===o);(!c||c.amount<t.amount)&&this.placeOrder(e.seed_a,r,t.amount-(c?c.orderAmount:0)),(!m||m.amount<t.amount)&&this.placeOrder(e.seed_b,o,t.amount-(m?m.orderAmount:0));let u=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}}),l=u.filter(e=>{let t=this.memory.resources.lab.find(t=>t.id===e.id);return!t||t.reactionState===LAB_IDLE});for(let h=0;h<l.length;h++){let e=l[h],r=this.memory.resources.lab.find(t=>t.id===e.id);r||(this.prepareReactionOrder(e.id,t.type,t.amount),r=this.memory.resources.lab.find(t=>t.id===e.id)),r&&(r.reactionType=t.type)}if(i.mineralType===r&&n.mineralType===o){let e=Math.floor(Math.min(i.mineralAmount,n.mineralAmount,t.amount)/LAB_REACTION_AMOUNT);if(0!==e){let r=0;for(let o=0;o<l.length;o++){let s=l[o];(0===s.mineralAmount||s.mineralType===t.type&&s.mineralAmount<=s.mineralCapacity-LAB_REACTION_AMOUNT&&r<e)&&(r++,s.runReaction(i,n)===OK&&(t.amount-=LAB_REACTION_AMOUNT,DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"processLabs",reactorType:REACTOR_TYPE_FLOWER,labId:s.id,resourceType:t.type,amountRemaining:t.amount})))}}}}}}}},Room.prototype.processReactorFlower=function(){let e=this.memory.resources.reactions;if(e&&e.reactorType===REACTOR_TYPE_FLOWER){for(let t=0;t<e.orders.length&&e.orders[t].amount<LAB_REACTION_AMOUNT;t++)e.orders.splice(t--,1);if(0===e.orders.length){let t=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}});for(let r=0;r<t.length;r++){let e=t[r],o=this.memory.resources.lab.find(t=>t.id===e.id);!o||o.reactionState!==LAB_IDLE&&o.reactionState!==LAB_SEED||this.cancelReactionOrder(e.id)}return void(e.reactorMode=REACTOR_MODE_IDLE)}let r=e.orders[0];switch(e.reactorMode=r.mode,e.reactorMode){case REACTOR_MODE_BURST:this.processReactorFlowerBurst()}}},Room.prototype.processLabs=function(){if(Game.time%LAB_COOLDOWN===5){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_LAB}});if(this.memory.resources){let t=e.filter(e=>{let t=this.memory.resources.lab.find(t=>t.id==e.id);return!!t&&(t.slave_a&&t.slave_b)});for(let r=0;r<t.length;r++){let e=t[r];if(!(e.cooldown>0)){let t=this.memory.resources.lab.find(t=>t.id==e.id);if(t){let r=t.reactionType;if(!(e.mineralAmount>0&&e.mineralType!=r)){let o=Game.getObjectById(t.slave_a),i=Game.getObjectById(t.slave_b);o&&o.mineralType==LAB_REACTIONS[r][0]&&i&&i.mineralType==LAB_REACTIONS[r][1]&&e.runReaction(o,i)==OK&&(t.reactionAmount-=LAB_REACTION_AMOUNT,DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"processLabs",labId:e.id,resourceType:r,amountRemaining:t.reactionAmount}),t.reactionAmount<=0&&this.cancelReactionOrder(e.id))}}}}let o=this.memory.resources.reactions;if(o)switch(o.reactorType){case REACTOR_TYPE_FLOWER:this.processReactorFlower()}}}},Room.prototype.processPower=function(){let e=this.find(FIND_MY_STRUCTURES,{filter:e=>{return e.structureType==STRUCTURE_POWER_SPAWN}});for(var t=0;t<e.length;t++){let r=e[t];r.energy>=POWER_SPAWN_ENERGY_RATIO&&r.power>=1&&(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"processPower"}),r.processPower())}},Room.prototype.findContainerWith=function(e,t){t||(t=1);let r=this.memory;if(r&&r.container&&r.container.length>0)for(let o=0;o<r.container.length;o++){let i=r.container[o],n=Game.getObjectById(i.id);if(n){let r=-n.getNeeds(e);if((!this.structures.container.out.includes(n)||e!==RESOURCE_ENERGY)&&r>0){let e=r;if(e>=t)return{structure:n,amount:e}}}}return null},Room.prototype.prepareResourceOrder=function(e,t,r){let o=Game.getObjectById(e);if(!this.my||!o||!o.room.name==this.name||o.structureType!=STRUCTURE_LAB&&o.structureType!=STRUCTURE_POWER_SPAWN&&o.structureType!=STRUCTURE_CONTAINER&&o.structureType!=STRUCTURE_STORAGE&&o.structureType!=STRUCTURE_TERMINAL)return ERR_INVALID_TARGET;if(!RESOURCES_ALL.includes(t))return ERR_INVALID_ARGS;if(void 0===this.memory.resources&&(this.memory.resources={lab:[],powerSpawn:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]),this.memory.resources[o.structureType].find(t=>t.id==e)||this.memory.resources[o.structureType].push(o.structureType==STRUCTURE_LAB?{id:e,orders:[],reactionState:LAB_IDLE}:{id:e,orders:[]}),o.structureType==STRUCTURE_LAB&&t!=RESOURCE_ENERGY&&r>0){let r=this.memory.resources[STRUCTURE_LAB].find(t=>t.id==e).orders;for(let o=0;o<r.length;o++)r[o].type!=t&&r[o].type!=RESOURCE_ENERGY&&(r[o].orderAmount=0,r[o].orderRemaining=0,r[o].storeAmount=0)}return OK},Room.prototype.cancelOrder=function(e,t=null){let r=Game.getObjectById(e);if(this.prepareResourceOrder(e,RESOURCE_ENERGY,0)!=OK)return ret;let o=this.memory.resources[r.structureType].find(t=>t.id==e);if(o)if(t){let e=o.orders.find(e=>e.type==t);e&&(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"cancelOrder",orderId:orderId,resourceType:t}),o.orders.splice(o.orders.indexOf(e),1))}else DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"cancelOrder",orderId:orderId,resourceType:"all"}),o.orders=[];return OK},Room.prototype.placeOrder=function(e,t,r){let o=Game.getObjectById(e),i=this.prepareResourceOrder(e,t,r);if(i!=OK)return i;let n=this.memory.resources[o.structureType].find(t=>t.id==e);if(n){let e=n.orders.find(e=>e.type==t);if(e)e.orderAmount+=r,e.orderRemaining+=r;else{let e=0;e=o.structureType===STRUCTURE_LAB?o.mineralType==t?o.mineralAmount:0:o.store[t]||0,n.orders.push({type:t,orderAmount:r,orderRemaining:r-e,storeAmount:0}),o.structureType===STRUCTURE_LAB&&(n.reactionType=t)}}return OK},Room.prototype.setStore=function(e,t,r){let o=Game.getObjectById(e),i=this.prepareResourceOrder(e,t,r);if(i!=OK)return i;let n=this.memory.resources[o.structureType].find(t=>t.id==e);if(n){let e=n.orders.find(e=>e.type==t);e?e.storeAmount=r:n.orders.push({type:t,orderAmount:0,orderRemaining:0,storeAmount:r})}return OK},Room.prototype.cancelRoomOrder=function(e=null,t=null){void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]),void 0===this.memory.resources.orders&&(this.memory.resources.orders=[]);let r=this.memory.resources.orders;if(e&&t){let o=r.find(r=>{return r.id==e&&r.type==t});o&&(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"cancelRoomOrder",orderId:e,resourceType:t}),r.splice(r.indexOf(o),1))}else if(e){DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"cancelRoomOrder",orderId:e,resourceType:"all"});for(let t=0;t<r.length;t++){let o=r[t];o.id===e&&r.splice(t--,1)}}else this.memory.resources.orders=[];return OK},Room.prototype.placeRoomOrder=function(e,t,r){if(r<=0)return OK;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]),void 0===this.memory.resources.orders&&(this.memory.resources.orders=[]);let o=this.memory.resources.orders,i=o.find(r=>{return r.id==e&&r.type==t});return i?(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"placeRoomOrder",subAction:"update",orderId:e,resourceType:t,amount:r}),i.amount=r):(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"placeRoomOrder",subAction:"new",orderId:e,resourceType:t,amount:r}),DEBUG&&logSystem(this.name,`New room order with id ${e} placed for ${r} ${t}.`),o.push({id:e,type:t,amount:r,offers:[]})),OK},Room.prototype.cancelReactionOrder=function(e){let t=this.memory.resources.lab.find(t=>t.id==e);if(t){t.slave_a&&this.cancelReactionOrder(t.slave_a),t.slave_b&&this.cancelReactionOrder(t.slave_b);let e=[LAB_MASTER,LAB_SLAVE_1,LAB_SLAVE_2,LAB_SLAVE_3];e.includes(t.reactionState)&&(t.reactionState=LAB_IDLE),delete t.reactionType,delete t.reactionAmount,delete t.master,delete t.slave_a,delete t.slave_b,void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.orders&&(this.memory.resources.orders=[]);this.memory.resources.orders;for(let r=0;r<t.orders.length;r++){let e=t.orders[r];e.type!=RESOURCE_ENERGY&&(e.orderAmount=0,e.orderRemaining=0,e.storeAmount=0)}}return OK},Room.prototype.prepareReactionOrder=function(e,t,r){if(r<=0)return OK;let o=Game.getObjectById(e);if(!this.my||!o||!o.structureType==STRUCTURE_LAB)return ERR_INVALID_TARGET;if(!LAB_REACTIONS.hasOwnProperty(t))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]});let i=this.memory.resources.lab.find(t=>t.id==e);return i||(this.memory.resources.lab.push({id:e,orders:[],reactionState:LAB_IDLE}),i=this.memory.resources.lab.find(t=>t.id==e)),this.cancelReactionOrder(e),OK},Room.prototype.placeBasicReactionOrder=function(e,t,r,o=1){if(r<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(t))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=Game.getObjectById(e),n=LAB_REACTIONS[t][0],s=LAB_REACTIONS[t][1],a=null,c=null,m=i.pos.findInRange(FIND_MY_STRUCTURES,2,{filter:e=>{return e.structureType==STRUCTURE_LAB&&e.id!=i.id}});for(let u=0;u<m.length;u++){let e=m[u],t=this.memory.resources.lab.find(t=>t.id==e.id);if(null==a&&t&&t.reactionType==n?a=e:null==c&&t&&t.reactionType==s&&(c=e),a&&c)break}if(!a||!c){m.sort((e,t)=>i.pos.getRangeTo(e)-i.pos.getRangeTo(t));for(let e=0;e<m.length;e++){let t=m[e],r=this.memory.resources.lab.find(e=>e.id==t.id);r&&r.reactionState&&r.reactionState!=LAB_IDLE||(null==a?a=t:null==c&&(c=t))}}if(null==a||null==c)return ERR_NOT_FOUND;let l=this.prepareReactionOrder(e,t,r);if(l!=OK)return l;if(l=this.prepareReactionOrder(a.id,t,r),l!=OK)return l;if(l=this.prepareReactionOrder(c.id,t,r),l!=OK)return l;let h=this.memory.resources.lab.find(t=>t.id==e),f=LAB_MASTER;h&&(h.reactionState==LAB_SLAVE_1&&(f=LAB_SLAVE_1),h.reactionState==LAB_SLAVE_2&&(f=LAB_SLAVE_2),h.reactionState=f,h.reactionType=t,h.reactionAmount=r,h.slave_a=a.id,h.slave_b=c.id),h=this.memory.resources.lab.find(e=>e.id==a.id);let R=LAB_SLAVE_1,d=1;if(f==LAB_SLAVE_1?(R=LAB_SLAVE_2,d=2):f==LAB_SLAVE_2&&(R=LAB_SLAVE_3,d=3),h){h.reactionState=R,h.reactionType=n,h.master=i.id,this.placeOrder(a.id,n,r);let e=0;if(this.memory.container)for(let t=0;t<this.memory.container.length;t++){let r=this.memory.container[t],o=Game.getObjectById(r.id);o&&o.store[n]&&(e+=o.store[n])}if(this.storage&&(e+=this.storage.store[n]||0),this.terminal&&(e+=this.terminal.store[n]||0),o>d&&d<3&&e<r&&this.placeReactionOrder(a.id,n,r-e)==OK){let t=h.orders.find(e=>e.type==n);t&&(t.orderRemaining=e)}}if(h=this.memory.resources.lab.find(e=>e.id==c.id)){h.reactionState=R,h.reactionType=s,h.master=i.id,this.placeOrder(c.id,s,r);let e=0;if(this.memory.container)for(let t=0;t<this.memory.container.length;t++){let r=this.memory.container[t],o=Game.getObjectById(r.id);o&&(e+=o.store[s]||0)}if(this.storage&&(e+=this.storage.store[s]||0),this.terminal&&(e+=this.terminal.store[s]||0),o>d&&d<3&&e<r&&this.placeReactionOrder(a.id,n,r-e)==OK){let t=h.orders.find(e=>e.type==s);t&&(t.orderRemaining=e)}}return OK},Room.prototype.placeFlowerReactionOrder=function(e,t,r,o=REACTOR_MODE_BURST){if(r<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(t))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=this.memory.resources;if(i.reactions){let n=i.reactions.orders.find(r=>{return r.id==e&&r.type==t});n?(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"placeReactionOrder",subAction:"update",orderId:e,resourceType:t,amount:r}),n.mode=o,n.amount=r):(DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"placeReactionOrder",subAction:"new",orderId:e,resourceType:t,amount:r}),i.reactions.orders.push({id:e,type:t,mode:o,amount:r})),i.reactions.reactorMode=o}return OK},Room.prototype.placeReactionOrder=function(e,t,r,o=REACTOR_MODE_BURST){if(r<=0)return OK;if(!LAB_REACTIONS.hasOwnProperty(t))return ERR_INVALID_ARGS;void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let i=Game.getObjectById(e);if(i&&i.structureType===STRUCTURE_LAB)return this.placeBasicReactionOrder(e,t,r,1);let n=this.memory.resources;if(!n.reactions)return DEBUG&&TRACE&&trace("Room",{roomName:this.name,actionName:"placeRoomOrder",subAction:"no_reactor"}),ERR_INVALID_TARGET;n.reactions.reactorType;switch(n.reactions.reactorType){case REACTOR_TYPE_FLOWER:this.placeFlowerReactionOrder(e,t,r,o)}return OK},Room.prototype.registerReactorFlower=function(e,t){void 0===this.memory.resources&&(this.memory.resources={lab:[],container:[],terminal:[],storage:[]}),void 0===this.memory.resources.powerSpawn&&(this.memory.resources.powerSpawn=[]);let r=Game.getObjectById(e),o=Game.getObjectById(t);if(!r||!o||r.structureType!==STRUCTURE_LAB||o.structureType!==STRUCTURE_LAB)return ERR_INVALID_TARGET;let i=this.memory.resources;return void 0===i.reactions&&(i.reactions={orders:[]}),i.reactions.reactorType=REACTOR_TYPE_FLOWER,i.reactions.reactorMode=REACTOR_MODE_IDLE,i.reactions.seed_a=e,i.reactions.seed_b=t,data_a=i.lab.find(t=>t.id===e),data_a&&(data_a.reactionState=LAB_SEED),data_b=i.lab.find(e=>e.id===t),data_b&&(data_b.reactionState=LAB_SEED),OK},Room.prototype.isWalkable=function(e,t,r){r=r?r[t][e]:this.lookAt(e,t);let o=e=>{return e.type==LOOK_TERRAIN&&"wall"==e.terrain||OBSTACLE_OBJECT_TYPES.includes(e[e.type].structureType)};return 0==r.filter(o).length},Room.prototype.exits=function(e,t){t===!0&&(t=.5);let r;r=0===e?_.chain(this.find(FIND_STRUCTURES)).filter(function(e){return e.structureType===STRUCTURE_PORTAL}).map("pos").value():this.find(e);let o,i,n={},s=-1;const a=[];for(let c=0;c<r.length;c++){const e=r[c];_.get(n,[e.x-1,e.y])||_.get(n,[e.x,e.y-1])||(t&&s!==-1&&(a[s].x+=Math.ceil(t*(o-a[s].x)),a[s].y+=Math.ceil(t*(i-a[s].y))),s++,a[s]=_.pick(e,["x","y"]),o=e.x,i=e.y,n={}),_.set(n,[e.x,e.y],!0),o=Math.max(o,e.x),i=Math.max(i,e.y)}return t&&s!==-1&&(a[s].x+=Math.ceil(t*(o-a[s].x)),a[s].y+=Math.ceil(t*(i-a[s].y))),a},Room.prototype.printCostMatrix=function(e,t){const r=e?this.creepMatrix:this.costMatrix;let o=0,i=50,n=0,s=50;t&&(o=Math.max(0,t.y-3),i=Math.min(50,t.y+4),n=Math.max(0,t.x-3),s=Math.min(50,t.x+4)),logSystem(this.name,"costMatrix:");for(var a=o;a<i;a++){for(var c="",m=n;m<s;m++){var u=r.get(m,a).toString(16);"0"==u&&(u=""),c+=("   "+u).slice(-3)}logSystem(this.name,c)}},Room.prototype.controlObserver=function(){const e=this.structures.observer;if(e){this.memory.observer.rooms||this.initObserverRooms();let t;if(observerRequests.length>0)for(const r of observerRequests)if(Game.map.getRoomLinearDistance(this.name,r.roomName)<=10&&!Memory.observerSchedule.includes(r.roomName)){const e=r.room||Game.rooms[r.roomName];if(e&&e.creeps&&e.creeps.length&&e.creeps.length>0)continue;Memory.observerSchedule.push(r.roomName),t=r.roomName;break}let o=0;const i=this.memory.observer.rooms;if(!t){let e=Number.isInteger(this.memory.observer.lastLookedIndex)?this.memory.observer.lastLookedIndex:i.length;do if(t=e>=i.length?i[0]:i[e+1],e=i.indexOf(t),++o>=i.length)break;while(Memory.observerSchedule.includes(t)||t in Game.rooms);this.memory.observer.lastLookedIndex=e,Memory.observerSchedule.push(t)}const n=e.observeRoom(t);n===ERR_INVALID_ARGS&&o<i.length&&(Memory.observerSchedule.splice(Memory.observerSchedule.indexOf(t),1),this.controlObserver())}},Room.prototype.initObserverRooms=function(){const e=OBSERVER_OBSERVE_RANGE>10?10:OBSERVER_OBSERVE_RANGE,[t,r]=Room.calcGlobalCoordinates(this.name,(e,t)=>[e,t]),[o,i]=Room.calcCardinalDirection(this.name);this.memory.observer.rooms=[];for(let n=t-e;n<t+e;n++)for(let s=r-e;s<r+e;s++){let e=o,t=i,r=n;n<0&&(e="W"===e?"E":"W",r=Math.abs(n)-1),e+=r,r=s,s<0&&(t="N"===t?"S":"N",r=Math.abs(s)-1),t+=r;const a=e+t;OBSERVER_OBSERVE_HIGHWAYS_ONLY&&!Room.isHighwayRoom(a)||a in Game.rooms&&Game.rooms[a].my||Game.map.isRoomAvailable(a)&&this.memory.observer.rooms.push(a)}}},t.flush=function(){let e=e=>{delete e._sourceEnergyAvailable,delete e._droppedResources,delete e._ticksToNextRegeneration,delete e._relativeEnergyAvailable,delete e._towerFreeCapacity,delete e._hostiles,delete e._hostileIds,delete e._situation,delete e._casualties,delete e._currentCostMatrix,delete e._isReceivingEnergy,delete e._reservedSpawnEnergy,delete e._creeps,delete e._immobileCreeps,delete e._allCreeps,delete e._privateerMaxWeight,delete e._claimerMaxWeight,delete e._combatCreeps,delete e._defenseLevel,delete e._hostileThreatLevel,delete e._collapsed,global.isNewServer?(delete e._my,delete e._constructionSites,delete e._myConstructionSites,delete e._maxPerJob,delete e._minerals,delete e._structures):(delete e.structures._repairable,delete e.structures._urgentRepairableSites,delete e.structures._fortifyableSites,delete e.structures._fuelables),e._powerBank||delete e.memory.powerBank,e.newInvader=[],e.goneInvader=[]};if(Memory.observerSchedule=[],_.forEach(Game.rooms,e),!_.isUndefined(Memory.rooms.hostileRooms)){for(roomName in Memory.rooms.hostileRooms)_.isUndefined(Memory.rooms[roomName])&&(Memory.rooms[roomName]={}),Memory.rooms[roomName].hostile=Memory.rooms.hostileRooms[roomName];delete Memory.rooms.hostileRooms}},t.totalSitesChanged=function(){const e=_.size(Game.constructionSites),t=Memory.rooms.myTotalSites||0;return e>0?Memory.rooms.myTotalSites=e:delete Memory.rooms.myTotalSites,t&&t!==e},t.totalStructuresChanged=function(){const e=_.size(Game.structures),t=Memory.rooms.myTotalStructures||0;return e>0?Memory.rooms.myTotalStructures=e:delete Memory.rooms.myTotalStructures,t&&t!==e},t.analyze=function(){const e=Util.startProfiling("Room.analyze",{enabled:PROFILING.ROOMS}),t=Room.totalSitesChanged(),r=Room.totalStructuresChanged(),o=e=>{try{e.memory.initialized&&Game.time%MEMORY_RESYNC_INTERVAL!=0&&"sim"!=e.name||(e.memory.initialized=Game.time,e.saveMinerals(),e.saveTowers(),e.saveSpawns(),e.saveObserver(),e.saveNukers(),e.savePowerSpawns(),e.saveExtensions(),e.saveContainers(),e.saveLinks(),e.saveLabs(),e.structures.observer&&e.initObserverRooms(),e.processConstructionFlags()),Game.time%PROCESS_ORDERS_INTERVAL!==0&&"sim"!==e.name||(e.updateResourceOrders(),e.updateRoomOrders(),e.terminalBroker()),e.roadConstruction(),e.structures.links.all.length>0&&e.linkDispatcher(),e.hostiles.length>0&&e.processInvaders(),e.structures.labs.all.length>0&&e.processLabs(),e.structures.powerSpawn&&e.processPower(),t&&e.countMySites(),r&&e.countMyStructures()}catch(t){Game.notify('Error in room.js (Room.prototype.loop) for "'+e.name+'" : '+t.stack?t+"<br/>"+t.stack:t),console.log(dye(CRAYON.error,'Error in room.js (Room.prototype.loop) for "'+e.name+'": <br/>'+(t.stack||t.toString())+"<br/>"+t.stack))}};_.forEach(Game.rooms,t=>{o(t),e.checkCPU(t.name,PROFILING.ANALYZE_LIMIT/5)})},t.execute=function(){const e=Util.startProfiling("Room.execute",{enabled:PROFILING.ROOMS});let t=e=>{let t=JSON.stringify(_.countBy(e.body,"type"));(DEBUG||NOTIFICATE_INVADER||NOTIFICATE_INTRUDER&&e.room.my||NOTIFICATE_HOSTILES)&&logSystem(e.pos.roomName,`Hostile intruder (${t}) from "${e.owner.username}".`),
(NOTIFICATE_INVADER||NOTIFICATE_INTRUDER&&"Invader"!==e.owner.username&&e.room.my||NOTIFICATE_HOSTILES&&"Invader"!==e.owner.username)&&Game.notify(`Hostile intruder ${e.id} (${t}) from "${e.owner.username}" in room ${e.pos.roomName} at ${toDateTimeString(toLocalDate(new Date))}`),Room.newInvader.trigger(e)},r=e=>Room.knownInvader.trigger(e),o=e=>Room.goneInvader.trigger(e),i=(e,i)=>{try{const n=Util.startProfiling(i,{enabled:PROFILING.ROOMS});let s=Game.rooms[i];s?(s.goneInvader.forEach(o),n.checkCPU("Creep.execute.run:goneInvader",.5),s.hostileIds.forEach(r),n.checkCPU("Creep.execute.run:knownInvaders",.5),s.newInvader.forEach(t),n.checkCPU("Creep.execute.run:newInvaders",.5),s.structures.towers.length>0&&Tower.loop(s),n.checkCPU("Creep.execute.run:tower.loop",.5),s.collapsed&&Room.collapsed.trigger(s),n.checkCPU("Creep.execute.run:collapsed",.5)):(e.hostileIds&&_.forEach(e.hostileIds,r),n.checkCPU("Creep.execute.run:knownInvadersNoSight",.5))}catch(e){Util.logError(e.stack||e.message)}};_.forEach(Memory.rooms,(t,r)=>{i(t,r),e.checkCPU(r+".run",1);let o=Game.rooms[r];o&&(o.structures.observer&&o.controlObserver(),e.checkCPU(r+".controlObserver",.5))})},t.cleanup=function(){if(_.isUndefined(Memory.pathfinder)||(OCSMemory.saveSegment(MEM_SEGMENTS.COSTMATRIX_CACHE,Memory.pathfinder),delete Memory.pathfinder),t.pathfinderCacheDirty&&t.pathfinderCacheLoaded){let e={};for(const r in t.pathfinderCache){const o=t.pathfinderCache[r];o.version===t.COSTMATRIX_CACHE_VERSION&&(e[r]={serializedMatrix:o.serializedMatrix||o.costMatrix.serialize(),updated:o.updated,version:o.version})}OCSMemory.saveSegment(MEM_SEGMENTS.COSTMATRIX_CACHE,e),t.pathfinderCacheDirty=!1}},t.bestSpawnRoomFor=function(e){var t=t=>t.my?routeRange(t.name,e):1/0;return _.min(Game.rooms,t)},t.findSpawnRoom=function(e){if(!e||!e.targetRoom)return null;let t=t=>t.my&&(void 0===e.maxRange||Util.routeRange(t.name,e.targetRoom)<=e.maxRange)&&(void 0===e.minEnergyCapacity||e.minEnergyCapacity<=t.energyCapacityAvailable)&&(void 0===e.minEnergyAvailable||e.minEnergyAvailable<=t.energyAvailable)&&(t.name!=e.targetRoom||e.allowTargetRoom===!0)&&(void 0===e.minRCL||t.controller.level>=e.minRCL)&&(void 0===e.callBack||e.callBack(t)),r=_.filter(Game.rooms,t);if(0==r.length)return null;let o=e=>_.sum(e,e=>3*e.parts.length),i=e=>(.9*o(e.spawnQueueLow)+o(e.spawnQueueMedium)+1.1*o(e.spawnQueueHigh))/e.structures.spawns.length,n=t=>{return routeRange(t.name,e.targetRoom)+(8-t.controller.level)/(e.rangeRclRatio||3)+i(t)/(e.rangeQueueRatio||51)};return _.min(r,n)},t.routeCallback=function(e,r,o){return function(i){if(Game.map.getRoomLinearDistance(e,i)>o.restrictDistance)return!1;if(i!==r&&ROUTE_ROOM_COST[i])return ROUTE_ROOM_COST[i];let n=!1;if(o.preferHighway){const e=/^[WE]([0-9]+)[NS]([0-9]+)$/.exec(i);n=e[1]%10===0||e[2]%10===0}let s=!1;const a=_.get(Memory.rooms[i],"hostile",!1);if(o.checkOwner){const e=Game.rooms[i];s=!a||e&&e.controller&&(e.controller.my||void 0===e.controller.owner)}return!o.allowSK&&t.isSKRoom(i)?10:!o.allowHostile&&a&&i!==r&&i!==e?Number.POSITIVE_INFINITY:s||i==e||i==r?1:n?3:Game.map.isRoomAvailable(i)?o.checkOwner||o.preferHighway?11:1:Number.POSITIVE_INFINITY}},t.getCostMatrix=function(e){var t=Game.rooms[e];if(t)return t.costMatrix},t.isMine=function(e){let t=Game.rooms[e];return t&&t.my},t.calcCardinalDirection=function(e){const t=/^([WE])[0-9]+([NS])[0-9]+$/.exec(e);return[t[1],t[2]]},t.calcGlobalCoordinates=function(e,t){if(!t)return null;const r=/^[WE]([0-9]+)[NS]([0-9]+)$/.exec(e),o=+r[1],i=+r[2];return t(o,i)},t.calcCoordinates=function(e,t){return t?Room.calcGlobalCoordinates(e,(e,r)=>{return t(e%10,r%10)}):null},t.isCenterRoom=function(e){return Room.calcCoordinates(e,(e,t)=>{return 5===e&&5===t})},t.isCenterNineRoom=function(e){return Room.calcCoordinates(e,(e,t)=>{return e>3&&e<7&&t>3&&t<7})},t.isControllerRoom=function(e){return Room.calcCoordinates(e,(e,t)=>{return 0!==e&&0!==t&&(e<4||e>6||t<4||t>6)})},t.isSKRoom=function(e){return Room.calcCoordinates(e,(e,t)=>{return e>3&&e<7&&t>3&&t<7&&(5!==e||5!==t)})},t.isHighwayRoom=function(e){return Room.calcCoordinates(e,(e,t)=>{return 0===e||0===t})},t.adjacentRooms=function(e){let t=e.split(/([NESW])/),r=["N","E","S","W"],o=e=>r[(r.indexOf(e)+2)%4],i=[];for(let n=parseInt(t[2])-1;n<parseInt(t[2])+2;n++)for(let s=parseInt(t[4])-1;s<parseInt(t[4])+2;s++)i.push((n<0?o(t[1])+"0":t[1]+n)+(s<0?o(t[3])+"0":t[3]+s));return i},t.adjacentAccessibleRooms=function(e,t=true){let r=[],o=Game.map.describeExits(e),i=(e,o)=>{if(t){let t=Game.map.describeExits(e),i=(o+1)%8+1,n=(o+5)%8+1;t&&t[i]&&!r.includes(t[i])&&r.push(t[i]),t&&t[n]&&!r.includes(t[n])&&r.push(t[n])}r.push(e)};return _.forEach(o,i),r},t.roomDistance=function(e,t,r,o){if(r)return Game.map.getRoomLinearDistance(e,t,o);if(e==t)return 0;let i=e.split(/([NESW])/),n=t.split(/([NESW])/),s=i[1]==n[1]?Math.abs(i[2]-n[2]):i[2]+n[2]+1,a=i[3]==n[3]?Math.abs(i[4]-n[4]):i[4]+n[4]+1;return s+a},t.rebuildCostMatrix=function(e){DEBUG&&logSystem(e,"Removing invalid costmatrix to force a rebuild."),t.pathfinderCache[e]={},t.pathfinderCacheDirty=!0},t.loadCostMatrixCache=function(e){let r=0;for(const o in e)(!t.pathfinderCache[o]||t.pathfinderCache[o].updated<e[o].updated)&&(r++,t.pathfinderCache[o]=e[o]);DEBUG&&r>0&&logSystem("RawMemory","loading pathfinder cache.. updated "+r+" stale entries."),t.pathfinderCacheLoaded=!0},t.validFields=function(e,t,r,o,i,n=false,s=null){const a=Game.rooms[e],c=n?a.lookAtArea(o,t,i,r):null;let m=[];for(let u=t;u<=r;u++)for(let l=o;l<=i;l++)if(u>1&&u<48&&l>1&&l<48&&(!n||a.isWalkable(u,l,c))){let t=new RoomPosition(u,l,e);s&&!s(t)||m.push(t)}return m},t.fieldsInRange=function(e){let t=e.spots.map(e=>e.pos.x+e.range),r=e.spots.map(e=>e.pos.y+e.range),o=e.spots.map(e=>e.pos.x-e.range),i=e.spots.map(e=>e.pos.y-e.range),n=Math.max(...o),s=Math.min(...t),a=Math.max(...i),c=Math.min(...r);return Room.validFields(e.roomName,n,s,a,c,e.checkWalkable,e.where)},t.roomLayoutArray=[[,,,,,,,STRUCTURE_ROAD],[,,,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_SPAWN,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_SPAWN,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_SPAWN,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,,,STRUCTURE_ROAD,STRUCTURE_EXTENSION,STRUCTURE_ROAD],[,,,,,,,STRUCTURE_ROAD]],t.roomLayout=function(e){if(Flag.compare(e,FLAG_COLOR.command.roomLayout)){e=Game.flags[e.name];const t=e.room;if(t){const r=Room.roomLayoutArray,o={[STRUCTURE_SPAWN]:FLAG_COLOR.construct.spawn,[STRUCTURE_TOWER]:FLAG_COLOR.construct.tower,[STRUCTURE_EXTENSION]:FLAG_COLOR.construct},[i,n]=[e.pos.x,e.pos.y],s=[],a=[],c=()=>{return e.pos.newFlag(FLAG_COLOR.command.invalidPosition,"NO_ROOM"),e.remove(),!1};for(let m=0;m<r.length;m++)for(let u=0;u<r[m].length;u++){const e=Math.floor(i+(m-r.length/2)+1),l=Math.floor(n+(u-r.length/2)+1);if(e>=50||e<0||l>=50||l<0)return c();const h=t.getPositionAt(e,l),f=r[m]&&r[m][u];if(f){if("wall"===Game.map.getTerrainAt(h))return c();if(f===STRUCTURE_ROAD)a.push(h);else{const e=o[f];s.push({flagColour:e,pos:h})}}}s.forEach(e=>{e.pos.newFlag(e.flagColour)}),_.forEach(a,e=>{return!(_.size(Game.constructionSites)>=100)&&void e.createConstructionSite(STRUCTURE_ROAD)}),e.remove()}}};